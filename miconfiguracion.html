<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TurnoX - Sistema PRE-PAGO de Turnos On Line</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

  <!-- Fuentes -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Iconos -->
  <link rel="icon" type="image/png" href="https://i.ibb.co/p6Ycq6XC/Turnox-logo.png">

  <style>
    body {
      font-family: "Montserrat", sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #533482;
      color: #F2F2F2;
    }
    h1, h2, h3, h4 { font-weight: 600; margin: 0 0 10px 0; }
    h1 { text-align: center; font-size: 2rem; }

    button {
      background-color: #533482;
      color: #fff;
      border: none;
      border-radius: 0;
      padding: 8px 14px;
      margin: 4px 2px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background-color 0.2s, transform 0.1s;
    }
    button:hover { background-color: #452a7a; transform: translateY(-2px); }
    button:disabled { background-color: #ccc; cursor: not-allowed; }

    .profesional {
      border: 1px solid #ddd;
      padding: 12px;
      margin: 12px 0;
      background: #fff;
      color: #533482;
    }
    .profesional h3 { margin-bottom: 8px; }

    #config { margin-top: 20px; }
    #config h2 { margin-bottom: 12px; font-size: 18px; font-weight: 600; }
    #config h4 { margin: 10px 0 6px 0; font-size: 14px; font-weight: 500; }

    label.hora-label span {
      display: inline-block;
      padding: 6px 10px;
      font-weight: 600;
      border-radius: 0;
      transition: all 0.2s;
    }
    label.hora-label span.disponible { background: #F7F7F7; color: #533482; }
    label.hora-label span.disponible:hover { background-color: #533482; color: #fff; }
    label.hora-label span.bloqueado { background: #D2B8FF95; color: #F7F7F7; text-decoration: line-through; }
    label.hora-label span.selected { background-color: #533482; color: #fff; }

    input[type="time"], select {
      padding: 6px;
      border-radius: 0;
      border: 1px solid #ccc;
      margin: 4px 0;
      font-size: 14px;
      text-align: center;
    }
    @media(max-width:650px){
      .checkbox-row label span { padding: 4px 6px; font-size: 0.9rem; }
    }
  </style>
</head>
<body onload="init()">
  <button onclick="
      window.location.href='/creditos.html?username='
      + encodeURIComponent(username)
      + '&userId=' + encodeURIComponent(userId);
    ">
      ðŸ’³ CrÃ©ditos
  </button>

  <h1>Panel de ConfiguraciÃ³n</h1>
  <p>Usuario: <b id="who">â€”</b></p>

  <button onclick="agregarProfesional()">Agregar Profesional</button>
  <div id="profesionales"></div>
  <div id="config"></div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycby_-LL7wZkEg9Kzm3e5Y2yCb9nNdSOPznHT4TpRciiJcdWvSGgvbqZHVKKZtmZ98KR7_Q/exec"; 
  let userId = localStorage.getItem("userId");
  let username = localStorage.getItem("username");

  // --- detectar username de la URL si no estÃ¡ en localStorage ---
  const params = new URLSearchParams(window.location.search);
  if (!username) {
    const u = params.get("username");
    if (u) {
      username = u;
      localStorage.setItem("username", u);
    }
  }
  document.getElementById("who").innerText = username || "â€”";

  let profesionales = [];

  async function init() {
    if (!username) {
      alert("Debes iniciar sesiÃ³n primero o pasar ?username= en la URL.");
      window.location.href = "/login.html";
      return;
    }
    await cargarProfesionales();
  }

  async function cargarProfesionales() {
    const res = await fetch(`${API_URL}?username=${username}`);
    const data = await res.json();
    if (data.status === "ok") {
      profesionales = data.profesionales;
      renderProfesionales();
    }
  }

  function renderProfesionales() {
    const cont = document.getElementById("profesionales");
    cont.innerHTML = "";
    profesionales.forEach(prof => {
      const div = document.createElement("div");
      div.className = "profesional";
      div.innerHTML = `
        <h3>${prof.nombre}</h3>
        <button onclick="abrirTurnos('${prof.profesionalId}','${prof.nombre}')">Configurar Turnos</button>
        <button onclick="eliminarTurnos('${prof.profesionalId}')">ðŸ—‘ Limpiar Turnos</button>
      `;
      cont.appendChild(div);
    });
  }

  async function agregarProfesional() {
    const nombre = prompt("Nombre del profesional:");
    if (!nombre) return;
    const formData = new FormData();
    formData.append("action","addProfessional");
    formData.append("userId", userId);
    formData.append("nombre", nombre);
    const res = await fetch(API_URL, {method:"POST", body:formData});
    const data = await res.json();
    if (data.status === "ok") {
      profesionales.push({profesionalId:data.profesionalId, nombre:data.nombre});
      renderProfesionales();
    }
  }

  // --- configuraciÃ³n de turnos ---
  function abrirTurnos(profId, nombre) {
    const dias = ["Lunes","Martes","MiÃ©rcoles","Jueves","Viernes","SÃ¡bado","Domingo"];
    let html = `<h2>Turnos de ${nombre}</h2>`;
    html += `
      <label>Intervalo: 
        <select id="intervalo">
          <option value="15">15 min</option>
          <option value="20">20 min</option>
          <option value="30" selected>30 min</option>
          <option value="60">60 min</option>
        </select>
      </label><br><br>
    `;
    dias.forEach(d=>{
      html += `
        <h4>${d}</h4>
        Desde <input type="time" id="desde_${d}" value="09:00">
        hasta <input type="time" id="hasta_${d}" value="17:00">
        <button onclick="generarSlots('${profId}','${d}')">Generar</button>
        <div id="slots_${profId}_${d}" class="slots"></div>
      `;
    });
    html += `<br><button onclick="guardarTurnos('${profId}')">ðŸ’¾ Guardar</button>`;
    document.getElementById("config").innerHTML = html;
  }

  function generarSlots(profId, dia) {
    const intervalo = parseInt(document.getElementById("intervalo").value);
    const desde = document.getElementById(`desde_${dia}`).value;
    const hasta = document.getElementById(`hasta_${dia}`).value;
    const cont = document.getElementById(`slots_${profId}_${dia}`);
    cont.innerHTML = "";

    let [h,m] = desde.split(":").map(Number);
    let [hf,mf] = hasta.split(":").map(Number);

    while (h < hf || (h===hf && m < mf)) {
      const hora = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
      const id = `${profId}_${dia}_${hora}`;
      cont.innerHTML += `<label><input type="checkbox" id="${id}" data-dia="${dia}" data-hora="${hora}" checked> ${hora}</label> `;
      m += intervalo;
      if (m >= 60) { m = m-60; h++; }
    }
  }

  async function guardarTurnos(profId) {
    const checkboxes = document.querySelectorAll(`#config input[type=checkbox]`);
    const turnos = [];
    checkboxes.forEach(ch=>{
      turnos.push({dia: ch.dataset.dia, hora: ch.dataset.hora, visible: ch.checked ? 1 : 0});
    });

    const formData = new FormData();
    formData.append("action","saveTurnosStandard");
    formData.append("profesionalId", profId);
    formData.append("turnos", JSON.stringify(turnos));

    const res = await fetch(API_URL, {method:"POST", body:formData});
    const data = await res.json();
    alert("Turnos guardados correctamente.");
    // refrescar config para que el usuario vea lo que hizo
    abrirTurnos(profId, profesionales.find(p=>p.profesionalId===profId).nombre);
  }

  async function eliminarTurnos(profId) {
    if (!confirm("Â¿Seguro que quieres limpiar todos los turnos de este profesional?")) return;
    const formData = new FormData();
    formData.append("action","saveTurnosStandard");
    formData.append("profesionalId", profId);
    formData.append("turnos", JSON.stringify([]));
    await fetch(API_URL, {method:"POST", body:formData});
    alert("Turnos eliminados.");
    abrirTurnos(profId, profesionales.find(p=>p.profesionalId===profId).nombre);
  }
</script>
</body>
</html>
