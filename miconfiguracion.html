<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Configuración de Turnos</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#f9f9f9;}
    h1 { color:#333; }
    .day { margin-bottom: 20px; padding:10px; background:#fff; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.1);}
    .day h2 { margin:0 0 10px; color:#533482;}
    .slots { display:flex; flex-wrap:wrap; gap:8px;}
    .slot { padding:6px 10px; border-radius:6px; border:1px solid #ccc; background:#eee; font-size:14px; cursor:pointer;}
    .slot.unavailable { background:#f8d7da; text-decoration: line-through; color:#721c24;}
    .slot.available { background:#d4edda; color:#155724;}
    button { padding:10px 20px; border:none; background:#533482; color:#fff; border-radius:6px; cursor:pointer; font-size:16px;}
    button:hover { background:#412a68;}
  </style>
</head>
<body>
  <h1>Configuración de Turnos</h1>
  <div id="turnos"></div>
  <button id="guardarBtn">Guardar</button>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxpL3trtn3QD08UTOBR2ToRNb-UouL0PfiuNjJhDCCcZ-f0UqAacugvHRbgwKQVfHZhfw/exec";
    const username = new URLSearchParams(window.location.search).get("username");
    let turnosGlobal = [];

    async function cargarTurnos(){
      try {
        const res = await fetch(`${API_URL}?action=getTurnosStandard&username=${username}`);
        const data = await res.json();

        if (data.status === "ok") {
          turnosGlobal = Array.isArray(data.turnos) ? data.turnos : [];
          renderTurnos(turnosGlobal);
        } else {
          document.getElementById("turnos").innerHTML = "Error cargando turnos.";
        }
      } catch (e) {
        document.getElementById("turnos").innerHTML = "Error de conexión.";
      }
    }

    function renderTurnos(turnos){
      const cont = document.getElementById("turnos");
      cont.innerHTML = "";
      const dias = ["Lunes","Martes","Miércoles","Jueves","Viernes","Sábado","Domingo"];

      dias.forEach(dia => {
        const dayDiv = document.createElement("div");
        dayDiv.className = "day";
        const h2 = document.createElement("h2");
        h2.textContent = dia;
        dayDiv.appendChild(h2);

        const slotsDiv = document.createElement("div");
        slotsDiv.className = "slots";

        const slots = turnos.filter(t => (t.diaSemana||"").toLowerCase() === dia.toLowerCase());
        slots.sort((a,b)=>a.hora.localeCompare(b.hora));

        if (slots.length === 0) {
          slotsDiv.textContent = "No hay horarios configurados.";
        } else {
          slots.forEach((t, idx) => {
            const span = document.createElement("span");
            span.className = "slot " + (t.visible == 1 ? "available":"unavailable");
            span.textContent = t.hora;

            // Click para alternar estado
            span.addEventListener("click", () => {
              t.visible = t.visible == 1 ? 0 : 1;
              span.className = "slot " + (t.visible == 1 ? "available":"unavailable");
            });

            slotsDiv.appendChild(span);
          });
        }

        dayDiv.appendChild(slotsDiv);
        cont.appendChild(dayDiv);
      });
    }

    async function guardarTurnos(){
      const formData = new FormData();
      formData.append("action","saveTurnosStandard");
      formData.append("username", username);
      formData.append("turnos", JSON.stringify(turnosGlobal));

      await fetch(API_URL, {method:"POST", body:formData});
      alert("Turnos guardados correctamente.");
    }

    document.getElementById("guardarBtn").addEventListener("click", guardarTurnos);
    document.addEventListener("DOMContentLoaded", cargarTurnos);
  </script>
</body>
</html>
