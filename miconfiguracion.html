<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Turnos Semanales</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f6fa; }
    h1 { text-align: center; color: #2c3e50; }
    .container { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-top: 20px; }
    .day { background: #fff; border-radius: 8px; padding: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .day h3 { margin-top: 0; text-align: center; background: #3498db; color: white; border-radius: 6px; padding: 5px; }
    .slots { display: flex; flex-direction: column; gap: 6px; margin-top: 10px; }
    .slot { padding: 6px; border-radius: 6px; text-align: center; cursor: pointer; background: #2ecc71; color: white; font-weight: bold; transition: background 0.3s, opacity 0.3s; }
    .slot.bloqueado { background: #e74c3c; opacity: 0.6; text-decoration: line-through; }
  </style>
</head>
<body>

<h1>Turnos del Profesional</h1>
<div id="turnos" class="container"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxRK4WyJlagviZGIqibZd8sISBMwW8WzYKCk0Z6qd-JHYwoImVX3MlfdKACo931zGbaxQ/exec";
const username = localStorage.getItem("username") || "prueba1";

const diasES = ["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"];

async function cargarTurnos() {
  try {
    const res = await fetch(`${API_URL}?username=${username}`);
    const data = await res.json();
    console.log("Turnos cargados:", data);

    if (!data.turnos) {
      document.getElementById("turnos").innerHTML = "<p>No hay turnos configurados.</p>";
      return;
    }

    renderSemana(data.turnos);
  } catch (err) {
    console.error(err);
    document.getElementById("turnos").innerHTML = "<p>Error al cargar turnos.</p>";
  }
}

function renderSemana(turnosData) {
  const cont = document.getElementById("turnos");
  cont.innerHTML = "";

  const profId = Object.keys(turnosData)[0]; 
  const turnos = turnosData[profId] || [];

  // Agrupar por día de la semana
  const porDia = {};
  turnos.forEach(t => {
    if (!porDia[t.diaSemana]) porDia[t.diaSemana] = [];
    porDia[t.diaSemana].push(t);
  });

  diasES.forEach(dia => {
    const dayEl = document.createElement("div");
    dayEl.className = "day";
    dayEl.innerHTML = `<h3>${dia}</h3>`;

    const slots = porDia[dia] || [];
    let slotsHtml = `<div class="slots">` + 
      slots.map(s => `
        <span class="slot ${s.visible==0?'bloqueado':''}" 
              data-prof="${profId}" 
              data-dia="${dia}" 
              data-hora="${s.hora}">
          ${s.hora}
        </span>
      `).join("") + `</div>`;

    dayEl.innerHTML += slotsHtml;
    cont.appendChild(dayEl);
  });

  // Activar click en cada slot
  document.querySelectorAll(".slot").forEach(el=>{
    el.addEventListener("click", async ()=>{
      const prof = el.dataset.prof;
      const dia = el.dataset.dia;
      const hora = el.dataset.hora;

      try {
        const res = await fetch(`${API_URL}?action=toggleTurno&profId=${prof}&diaSemana=${encodeURIComponent(dia)}&hora=${encodeURIComponent(hora)}`);
        const data = await res.json();
        if (data.status==="ok") {
          if (data.visible==1) {
            el.classList.remove("bloqueado");
          } else {
            el.classList.add("bloqueado");
          }
        } else {
          alert("❌ Error: " + data.msg);
        }
      } catch(err) {
        alert("❌ No se pudo conectar con el servidor.");
      }
    });
  });
}

document.addEventListener("DOMContentLoaded", cargarTurnos);
</script>

</body>
</html>
