<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TurnoX - Editar disponibilidad (Lun‚ÄìDom)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --morado:#533482;
      --claro:#F4EDFF;
      --gris:#e7e7e7;
      --texto:#2b2b2b;
    }
    body{
      margin:0; padding:20px;
      font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--morado);
      color:#fff;
    }
    .topbar{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:16px;}
    h1{margin:0;font-size:22px;}
    button{
      background:#fff; color:var(--morado);
      border:none; border-radius:10px; padding:10px 14px;
      font-weight:700; cursor:pointer; transition:.2s;
    }
    button:hover{ transform:translateY(-2px); background:var(--claro);}
    .week{display:grid;gap:16px;grid-template-columns:repeat(4,1fr);}
    @media(max-width:900px){.week{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:520px){.week{grid-template-columns:1fr}}

    .day{background:#ffffff10;border:1px solid #ffffff30;border-radius:14px;padding:14px;}
    .day h2{margin:0 0 6px 0;font-size:18px;font-weight:700;}
    .date-tag{font-size:12px;opacity:.85;margin-bottom:10px}
    .prof{background:#fff;color:var(--texto);border-radius:12px;padding:10px;margin:10px 0;}
    .prof h3{margin:0 0 8px 0;font-size:15px;color:var(--morado)}
    .slots{display:flex;flex-wrap:wrap;gap:8px;}
    .slot{padding:6px 10px;border-radius:8px;border:1px solid var(--gris);
      font-weight:700;font-size:13px;background:#fff;cursor:pointer;transition:.2s;}
    .slot.bloqueado{opacity:.5;text-decoration:line-through;background:#eee;color:#888;}
    .legend{font-size:12px;margin-top:4px;opacity:.9}
    #saveBar{margin-top:20px;text-align:center;}
    #msg{margin-top:10px;font-size:14px;opacity:.9;}
  </style>
</head>
<body>
  <div class="topbar">
    <h1>Editar disponibilidad (Lun‚ÄìDom)</h1>
    <button onclick="window.location.href='/panel'">‚Üê Volver</button>
  </div>

  <div id="week" class="week"></div>

  <div id="saveBar">
    <button id="saveBtn">üíæ Guardar cambios</button>
    <div id="msg"></div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycby_-LL7wZkEg9Kzm3e5Y2yCb9nNdSOPznHT4TpRciiJcdWvSGgvbqZHVKKZtmZ98KR7_Q/exec";
    const username = new URLSearchParams(window.location.search).get("username") || "demo";

    const diasES = ["Domingo","Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado"];
    function toISODate(d){ return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().split("T")[0]; }
    function formatES(d){ return d.toLocaleDateString("es-AR",{weekday:"long", day:"2-digit", month:"2-digit"}); }

    async function fetchDay(isoDate){
      const res = await fetch(`${API_URL}?username=${encodeURIComponent(username)}&fecha=${isoDate}`);
      return res.json();
    }

    function renderDay(container,dateObj,data){
      const iso = toISODate(dateObj);
      const dayEl = document.createElement("div");
      dayEl.className = "day";
      dayEl.innerHTML = `<h2>${diasES[dateObj.getDay()]}</h2>
        <div class="date-tag">${formatES(dateObj)} ‚Äî ${iso}</div>`;
      const section = document.createElement("div");

      if (!data.turnos || Object.keys(data.turnos).length===0){
        section.innerHTML = `<div class="prof"><div class="slots empty">Sin horarios configurados.</div></div>`;
        dayEl.appendChild(section); container.appendChild(dayEl); return;
      }

      Object.values(data.turnos).forEach(prof=>{
        const box = document.createElement("div");
        box.className="prof";
        let slotsHtml="";
        const slots = prof.turnos || [];
        if (slots.length===0) slotsHtml="<div class='empty'>Sin horarios</div>";
        else{
          slotsHtml = "<div class='slots'>"+
            slots.map(s=>`<span class="slot ${s.estado==='bloqueado'?'bloqueado':''}" data-hora="${s.hora}" data-prof="${prof.id}" data-date="${iso}">${s.hora}</span>`).join("")
            +"</div>";
        }
        box.innerHTML=`<h3>${prof.nombre}</h3>${slotsHtml}`;
        section.appendChild(box);
      });

      dayEl.appendChild(section);
      container.appendChild(dayEl);
    }

    function toggleSlot(e){
      if (!e.target.classList.contains("slot")) return;
      e.target.classList.toggle("bloqueado");
    }

    async function init(){
      const weekDiv=document.getElementById("week");
      weekDiv.innerHTML="";
      const today=new Date();
      const days=[];
      for(let add=0; add<7; add++){
        const d=new Date(today); d.setDate(today.getDate()+add);
        days.push(d);
      }
      for(const d of days){
        const iso=toISODate(d);
        try{
          const data=await fetchDay(iso);
          if(data.status==="ok") renderDay(weekDiv,d,data);
          else weekDiv.innerHTML+="<div class='day'>Error al cargar "+iso+"</div>";
        }catch(err){ weekDiv.innerHTML+="<div class='day'>Error conexi√≥n</div>"; }
      }
      weekDiv.addEventListener("click",toggleSlot);
    }

    async function saveChanges(){
      const msg=document.getElementById("msg");
      msg.textContent="Guardando cambios, por favor espere‚Ä¶";
      const all=document.querySelectorAll(".slot");
      const cambios=[];
      all.forEach(slot=>{
        cambios.push({
          fecha:slot.dataset.date,
          hora:slot.dataset.hora,
          profesionalId:slot.dataset.prof,
          estado:slot.classList.contains("bloqueado")?"bloqueado":"disponible"
        });
      });
      try{
        const res=await fetch(API_URL,{
          method:"POST",
          body:JSON.stringify({action:"saveTurnosStandard",username,cambios})
        });
        const data=await res.json();
        if(data.status==="ok") msg.textContent="‚úÖ Cambios guardados correctamente";
        else msg.textContent="‚ùå Error: "+(data.msg||"no se pudo guardar");
      }catch(err){ msg.textContent="‚ùå Error de conexi√≥n al guardar"; }
    }

    document.getElementById("saveBtn").onclick=saveChanges;
    document.addEventListener("DOMContentLoaded",init);
  </script>
</body>
</html>
