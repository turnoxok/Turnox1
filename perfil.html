<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Perfil - TurnoX</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="color-scheme" content="light">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://i.ibb.co/p6Ycq6XC/Turnox-logo.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
  /* Mantengo todos tus estilos existentes */
  :root { color-scheme: light only; }
  body { font-family: "Montserrat", sans-serif; background-color: #4B2E78; color: #fff; margin: 0; padding: 0; text-align:center; }
  .header-info { position:absolute; top:15px; right:15px; display:flex; align-items:center; gap:15px; }
  .user-pill { padding:6px 12px; border-radius:999px; font-size:14px; background:#ffffff25; border:1px solid #ffffff40; margin:0; }
  .container { min-height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:20px; z-index:1; position:relative; padding:20px; }
  .card { width:90%; max-width:500px; background:#ffffff15; padding:30px 20px; border-radius:16px; backdrop-filter:blur(6px); border:1px solid #ffffff40; box-shadow:0 6px 20px rgba(0,0,0,0.3); text-align:center; display:flex; flex-direction:column; align-items:center; box-sizing:border-box; }
  .card input[type="url"], .card input[type="file"] { width:100%; padding:14px; font-size:16px; border-radius:12px; border:none; margin-bottom:20px; outline:none; box-sizing:border-box; }
  .card h2 { font-size:20px; margin-bottom:20px; color:#fff; }
  .card button { width:100%; padding:14px; font-size:16px; border-radius:12px; background:#25213C; color:#fff; border:none; cursor:pointer; transition:background 0.3s; }
  .card button:disabled { background:#99999950; }
  .card button:hover:enabled { background:#ffffff25; color:#fff; }
  .preview img { max-width:100%; border-radius:12px; margin-top:20px; }
  #status { font-family:"Montserrat",sans-serif; font-size:18px; font-weight:600; margin-top:15px; color:#fff; text-align:center; }
  #status.success { color:#fff; font-size:16px; font-weight:700; background:#ffffff20; padding:12px 18px; border-radius:12px; display:inline-block; box-shadow:0 4px 12px rgba(0,0,0,0.3); animation:pop 0.4s ease; }
  #status.error { color:#ff4c4c; font-weight:600; background:#ff4c4c20; padding:10px 16px; border-radius:10px; display:inline-block; }
  @keyframes pop { 0%{transform:scale(0.8);opacity:0;} 100%{transform:scale(1);opacity:1;} }
  #status a { display:inline-block; margin-top:10px; font-weight:700; text-decoration:none; background:#25213C; color:#5F48D7; padding:8px 14px; border-radius:8px; transition:0.2s; }
  #status a:hover { background:#ffffff25; color:#fff; }
  .btn-volver { font-family:"Montserrat",sans-serif; background:#25213C; color:#5F48D7; border:none; padding:12px 40px; border-radius:12px; font-size:16px; cursor:pointer; transition:background 0.2s; text-decoration:none; }
  .btn-volver:hover { background:#ffffff25; color:#fff; }
</style>
</head>
<body>

<!-- Header -->
<div class="header-info">
  <h2 class="user-pill">¡Hola! <span id="usernameDisplay"></span></h2>
</div>

<div class="container">
  <div class="card">
    <h2>Publicá tu logo!</h2>

    <!-- Subida a ImgBB -->
    <input type="file" id="logoFile" accept="image/*">
    <button id="uploadBtn">Subir a ImgBB</button>

    <!-- Preview y link -->
    <input type="url" id="logoUrl" placeholder="Link del logo" required>
    <div class="preview" id="preview"></div>

    <button id="saveBtn" disabled>Guardar Logo</button>
    <p id="status"></p>
  </div>

  <div style="text-align:center; margin-top:20px;">
    <a href="creditos.html" class="btn-volver">⬅ Volver</a>
  </div>
</div>

<script>
const storedUserId = localStorage.getItem("userId");
const storedUsername = localStorage.getItem("username");

if (!storedUserId || !storedUsername) window.location.href = "index.html";

document.getElementById("usernameDisplay").innerText = storedUsername;

const userId = storedUserId;
const logoInput = document.getElementById("logoUrl");
const saveBtn = document.getElementById("saveBtn");
const status = document.getElementById("status");
const preview = document.getElementById("preview");

const logoFile = document.getElementById("logoFile");
const uploadBtn = document.getElementById("uploadBtn");

// 1️⃣ Subir a ImgBB
uploadBtn.addEventListener("click", async () => {
  const file = logoFile.files[0];
  if (!file) return alert("Seleccioná un archivo primero");

  status.innerText = "Subiendo logo a ImgBB...";

  const reader = new FileReader();
  reader.onloadend = async () => {
    const base64 = reader.result.split(",")[1]; // solo la parte base64
    const formData = new FormData();
    formData.append("key", "5e7ff6621fb603a7835a4b4ec45fd4eb");
    formData.append("image", base64);

    try {
      const res = await fetch("https://api.imgbb.com/1/upload", {
        method: "POST",
        body: formData
      });
      const data = await res.json();
      console.log(data);
      if (data.success) {
        const url = data.data.url;
        status.innerText = "✅ Logo subido! URL copiada al campo de texto";
        logoInput.value = url; // poner URL en el input
        preview.innerHTML = `<img src="${url}" alt="Logo">`;
        saveBtn.disabled = false; // habilitar botón guardar
      } else {
        status.innerText = "❌ Error al subir: " + JSON.stringify(data);
      }
    } catch (e) {
      console.error(e);
      status.innerText = "❌ Error de conexión con ImgBB";
    }
  };
  reader.readAsDataURL(file);
});

// 2️⃣ Guardar en tu hoja de cálculo (Apps Script)
saveBtn.addEventListener("click", async () => {
  const logoUrl = logoInput.value.trim();
  if (!logoUrl || !userId) return;

  status.innerText = "Guardando logo en la hoja de cálculo...";

  try {
    const res = await fetch("https://script.google.com/macros/s/AKfycbwSHPQD3ZXVqMpPZ1E2cA9_ELs8hxScPkeEs5ReZ-_MwqZ9Wt3qvIgGy6pVk6STCebKBw/exec", {
      method: "POST",
      body: new URLSearchParams({
        action: "guardarLogoExterno",
        userId,
        logoUrl
      })
    });

    const data = await res.json();

    if (data.status === "ok") {
      status.className = "success";
      status.innerHTML = `Listo! Mirá cómo queda tu sitio:<br>
        <a href="https://turnox.pro/${storedUsername}" target="_blank">turnox.pro/${storedUsername}</a>`;
    } else {
      status.className = "error";
      status.innerText = "❌ Error: " + data.msg;
    }
  } catch (err) {
    console.error(err);
    status.className = "error";
    status.innerText = "❌ Error de conexión con Apps Script";
  }
});

// 3️⃣ Habilitar botón guardar si se pega un URL manualmente
logoInput.addEventListener("input", () => {
  saveBtn.disabled = !logoInput.value.trim();
  preview.innerHTML = logoInput.value.trim() ? `<img src="${logoInput.value.trim()}" alt="Logo">` : "";
});
</script>


</body>
</html>
