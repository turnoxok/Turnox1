<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TurnoX - Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

  <!-- Fuentes -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
 
 

  <!-- Iconos -->
  <link rel="icon" type="image/png" href="https://i.ibb.co/p6Ycq6XC/Turnox-logo.png">
  <link rel="icon" type="image/x-icon" href="favicon.ico">

  <!-- Open Graph para WhatsApp/Facebook -->
  <meta property="og:title" content=">TurnoX - Pro" />
  <meta property="og:description" content="Beauticians & Hairdressers" />
  <meta property="og:image" content="https://i.ibb.co/p6Ycq6XC/Turnox-logo.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:url" content="https://turnox.pro/" />
  <meta property="og:type" content="website" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="TurnoX - Pro" />
  <meta name="twitter:description" content="Beauticians & Hairdressers" />
  <meta name="twitter:image" content="https://i.ibb.co/p6Ycq6XC/Turnox-logo.png" />
   <style>
    html {
  scroll-behavior: smooth;
}
   body {
  font-family: "Montserrat", sans-serif;
  font-optical-sizing: auto;
  font-weight: 400;
  font-style: normal;
  margin: 0;
  padding: 0;
  background-color: #fff;
     color: #000;
     display: flex;
    flex-direction: column;
    min-height: 100vh;
     height: 100%;
 
    }

    
  header {
    position: relative;
    height: auto;
    display: flex;
    justify-content: center;
    align-items: center;
   
  }

  #floatingLogo {
    position: static;
    transform: none;
    margin: 0 auto;
    width: 100%;
     max-width: 600px;
    justify-content: center;
    align-items: center;
   
  }

  #floatingLogo img {
    width: 100%;
    height: auto;
    object-fit: contain;
  }

  header .login-btn {
  position: absolute;
  top: 0px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.6);
  color: white;
  padding: 12px 24px;
  border-radius: 0px 0px 12px 12px;
  text-decoration: none;     /* saca subrayado */
  transition: background 0.3s ease, opacity 0.3s ease;
  display: inline-block;
}

/* hover: pierde transparencia */
header .login-btn:hover,
header .login-btn:active {
  background: rgba(0,0,0,1);
}


  h1 {
    text-align: center;
    margin-bottom: 20px;
    font-size: 2rem;
  }

  


/* Calendario */
#calendario {
  margin: 20px auto 10px auto;
  max-width: 600px;
  width: 100%;  
  background: #000000;
  background-blend-mode: overlay;
  color: #fff; 
  border: 1px solid #00000030;
  border-radius: 16px;
  overflow: hidden;
  padding: 15px;
  backdrop-filter: blur(3px);
}

#calendario h2 {
  text-align: center;
  margin-bottom: 10px;
  text-transform: capitalize;
}

/* üîπ Contenedor de d√≠as scrollable */
#dias {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  padding: 10px 0;
  scroll-snap-type: x mandatory;
}

#dias .dia {
  min-width: 40px;
  text-align: center;
  flex-shrink: 0;
  scroll-snap-align: center;
  cursor: pointer;
  transition: all 0.2s;
}

#dias .dia-numero {
  height: 40px;
  line-height: 40px;
  border-radius: 10%;
  background: #222;
  margin-bottom: 4px;
}

#dias .dia-letra {
  font-size: 14px;
  opacity: 0.8;
}

#dias .dia-numero:hover {
  background: #ffffff33;
}

#dias .hoy .dia-numero {
  border: 2px solid #ffffff99;
}

#dias .seleccionado .dia-numero {
  background-color: #fff;
  color: #000;
}

#dias .bloqueado {
  cursor: not-allowed;
  color: #999;
  pointer-events: none;
}

#dias::-webkit-scrollbar {
  height: 4px;
}

#dias::-webkit-scrollbar-track {
  background: transparent;
}

#dias::-webkit-scrollbar-thumb {
  background: linear-gradient(90deg, #666, #aaa);
  border-radius: 10px;
}

     
#turnos {
  text-align: center;
 
}
  /* Turnos */
.turnos {
  margin: 15px auto;
  max-width: 600px;
  padding: 15px;
  background: #000000;
  background-blend-mode: overlay;
  color: #fff; 
  border: 2px solid #00000030;
  border-radius: 16px;
  backdrop-filter: blur(3px);

  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}

.turnos h3 {
  margin-bottom: 10px;
  text-align: center;
}

.select-servicio {
  margin-bottom: 15px;
}

.hora-container {
  display: grid;
  grid-template-columns: repeat(2, 1fr); /* 2 columnas para turnos */
  gap: 10px;
  width: 100%;
}

.hora {
  display: block;
  padding: 8px 12px;
  border-radius: 10px;
  font-weight: 600;
  text-align: center;
  min-width: 80px;
  transition: all 0.2s;
}

.hora.disponible {
  background: #ffffff99;
  color: #000000;
}

.hora.disponible:hover {
  background: #000000;
  color: #fff;
  cursor: pointer;
  transform: translateY(-2px);
}

.hora.bloqueado {
  background: #ccc;
  color: #F7F7F7;
  cursor: not-allowed;
  text-decoration: line-through;
  opacity: 0.6;
}

.hora.selected {
  background-color: #000000;
  color: #fff;
  transform: translateY(-2px);
}


 /* Formulario de reserva */
#reservaFormContainer {
  margin: 20px auto;
  max-width: 600px;
  background: #000000;
    background-blend-mode: overlay;
  color: #fff; 
    border: 2px solid #00000030;
    border-radius: 16px;
  padding: 20px;
  text-align: center; /* todo centrado */
  backdrop-filter: blur(3px);
}

#reservaForm {
  display: flex;
  flex-direction: column;
  align-items: center; /* centra inputs y botones */
}

#reservaForm input,
#reservaForm textarea,
#reservaForm button {
  width: 90%;
  padding: 10px;
  margin: 8px 0;
  border-radius: 16px; 
  border: 1px solid #fff;
  font-family: 'Montserrat', sans-serif;
  text-align: center;
  box-sizing: border-box;
   background-color: #000000;
  color: #fff;
}

#reservaForm button {
  background-color: #fff;
  color: #000;
  border: none;
  border-radius: 16px; 
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

#reservaForm button:hover {
  background-color: #ccc;
  transform: translateY(-2px);
}

#reservaMsg {
  margin-top: 10px;
  text-align: center;
  font-weight: 600;
}

@media(max-width: 650px){
  #calendario,
  .turnos,
  #reservaFormContainer {
    width: 80%;
    padding: 10px;
  }
  .hora {
    padding: 6px 10px;
    font-size: 0.9rem;
  }
}
#reservaForm label i {
  font-family: "Font Awesome 6 Free"; /* fuerza la fuente FA */
  font-weight: 900; /* necesario para los s√≥lidos (fas) */
  margin-right: 5px; /* separaci√≥n del texto */
  display: inline-block;
  vertical-align: middle;
  color: inherit; /* hereda color del label */
}

#reservaForm label {
  display: flex;
  align-items: center;
}
    .ticket {
      font-family: "Montserrat", sans-serif;
  font-optical-sizing: auto;
  font-weight: 400;
  font-style: normal;
  margin: 20px auto;
  max-width: 500px;
 background: #000000;
    background-blend-mode: overlay;
  color: #fff; 
    border: 2px solid #00000030;
    border-radius: 0px;
  padding: 20px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  text-align: left;
}
.ticket h2 {
  font-family: "Montserrat", sans-serif;
  font-optical-sizing: auto;
  font-weight: 700;
  font-style: bold;
  text-align: center;
  color: #fff;
  margin-bottom: 15px;
}
.ticket p {
  font-family: "Montserrat", sans-serif;
  font-optical-sizing: auto;
  font-weight: 400;
  font-style: normal;
  margin: 6px 0;
  font-size: 0.95rem;
}
.ticket button {
  font-family: "Montserrat", sans-serif;
  font-optical-sizing: auto;
  font-weight: 400;
  font-style: normal;
  margin-top: 15px;
  padding: 14px 16px;
  border: none;
  border-radius: 10px;
  background: #fff;
  color: #000;
  cursor: pointer;
  display: block;
  margin-left: auto;
  margin-right: auto;
}
.ticket button:hover {
  background: #ccc;
}


        .grid {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  gap: 30px;
  justify-content: center;
  align-items: center;
  z-index: -1;
  pointer-events: none;
}

.col {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.rect {
  width: 80px;
  height: 120px;
  border: 2px solid #E5E5E850;
  border-radius: 12px;
}

.rect.filled {
  background: #E5E5E8;
}

.down .rect {
  animation: moveDown 20s linear infinite;
}

.up .rect {
  animation: moveUp 20s linear infinite;
}

/* Arrancan desde arriba de la pantalla y van hacia abajo */
@keyframes moveDown {
  0%   { transform: translateY(-150vh); opacity: 0; }
  10%  { opacity: 1; }
  100% { transform: translateY(150vh); opacity: 0; }
}

/* Arrancan desde abajo y suben hacia arriba */
@keyframes moveUp {
  0%   { transform: translateY(150vh); opacity: 0; }
  10%  { opacity: 1; }
  100% { transform: translateY(-150vh); opacity: 0; }
}
/* Para ocultar/mostrar con el atributo hidden */
[hidden] { display: none !important; } 
     input::placeholder,
textarea::placeholder {
  color: #fff;       
  opacity: 1;        
  font-family: "Montserrat", sans-serif;
}

  .select-servicio {
  display: block;
  width: 100%;
  max-width: 300px;
  margin: 10px 0;
  padding: 10px 14px;
  border-radius: 10px;

  border: 2px solid #B0B0B0;   /* gris claro contorno */
  background: #3A3A3A;         /* gris oscuro pleno */
  color: #f1f1f1;              /* texto en gris muy claro para contraste */
  font-size: 15px;
  font-weight: 500;
  cursor: pointer;

  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background-image: url("data:image/svg+xml;utf8,<svg fill='white' height='24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 16px;
    transition: all 0.3s ease; /* transici√≥n suave */
}

.select-servicio:focus {
  border-color: #888; /* un gris medio al hacer foco */
  outline: none;
  box-shadow: 0 0 0 3px rgba(180,180,180,0.3);
  
}
     .select-servicio:hover {
  background: #4A4A4A; /* un gris un poquito m√°s claro */
}

.select-servicio option {
  background: #3A3A3A;   /* gris oscuro fondo */
  color: #f1f1f1;        /* texto claro */
}

.select-servicio option:checked {
  background: #5A5A5A !important; /* cuando est√° seleccionada */
  color: #fff;
}

     .select-servicio option:checked,
.select-servicio option:hover {
  background-color: #5A5A5A !important; /* gris medio */
  color: #fff !important;
}

 #loadingScreen {
  position: fixed;
  top:0; left:0; width:100%; height:100%;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  background:#fff;
  z-index:9999;
  transition: opacity 0.5s ease;
}

.loading-logo {
  width:120px;
  margin-bottom:20px;
  animation: bounce 1s infinite alternate;
}

@keyframes bounce {
  from { transform: translateY(0); }
  to { transform: translateY(-10px); }
}

.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #533482;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin-bottom:10px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
   
</style>

</head>
<body>
  <div id="loadingScreen">
  <img src="https://i.ibb.co/p6Ycq6XC/Turnox-logo.png" alt="TurnoX" class="loading-logo">
  <div class="spinner"></div>
  <p>Cargando Sitio...</p>
</div>

<div class="grid">
  <div class="col down">
    <div class="rect filled"></div>
    <div class="rect"></div>
    <div class="rect"></div>
    <div class="rect"></div>
    <div class="rect"></div>
    <div class="rect filled"></div>
    <div class="rect"></div>
    <div class="rect"></div>
    <div class="rect"></div>
    <div class="rect"></div>
    <div class="rect"></div>
    <div class="rect"></div>
  </div>
  <div class="col up">
    <div class="rect"></div>
    <div class="rect filled"></div>
    <div class="rect"></div>
    <div class="rect"></div>
    <div class="rect"></div>
     <div class="rect"></div>
    <div class="rect"></div>
    <div class="rect"></div>
    <div class="rect"></div>
    <div class="rect"></div>
    <div class="rect"></div>
    <div class="rect filled"></div>
  </div>
  <div class="col down">
   <div class="rect"></div>
    <div class="rect"></div>
    <div class="rect filled"></div>
    <div class="rect"></div>
    <div class="rect"></div>
    <div class="rect"></div>
    
    <div class="rect"></div>
    <div class="rect"></div>
   <div class="rect filled"></div>
    <div class="rect"></div>
    <div class="rect"></div>
    <div class="rect"></div>
  </div>
</div>
  
  
 <header>
  <!-- Logo del usuario -->
<div id="floatingLogo">
  <div class="logo-container">
  <img id="userLogo"></div>
</div>
   <!-- Bot√≥n Login -->
    <a href="login.html" class="login-btn">Acceso</a>

   
 

 </header>
  
<!-- Bienvenida -->
<div class="welcome" style="text-align: center;">
  <p style="text-align: center; margin-bottom: -21px;">Bienvenido a</p>
  <h2><span id="businessName" style="margin-top: 1px; text-transform: uppercase; color: #000; text-align: center;"></span></h2>
</div>
  

 <div id="calendario"></div>

<div style="display:flex; gap:20px; align-items:center; justify-content:center;">
  <!-- Bot√≥n Mes anterior -->
  <button id="prevMonth" style="display:flex; align-items:center; gap:6px; padding:0; background:none; border:none; color:#000; cursor:pointer; font-size:16px;">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="18" viewBox="0 0 60 24" fill="none" stroke="#000" stroke-width="2" stroke-linecap="butt" stroke-linejoin="miter">
      <line x1="58" y1="12" x2="8" y2="12"></line>
      <polyline points="16,4 2,12 16,20"></polyline>
    </svg>
    Mes anterior
  </button>

  <!-- Bot√≥n Mes siguiente -->
  <button id="nextMonth" style="display:flex; align-items:center; gap:6px; padding:0; background:none; border:none; color:#000; cursor:pointer; font-size:16px;">
    Mes siguiente
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="18" viewBox="0 0 60 24" fill="none" stroke="#000" stroke-width="2" stroke-linecap="butt" stroke-linejoin="miter">
      <line x1="2" y1="12" x2="52" y2="12"></line>
      <polyline points="44,4 58,12 44,20"></polyline>
    </svg>
  </button>
</div>

  <div id="turnos">

  </div>
  <div id="reservaFormContainer" style="display:none;">
 
  

    
  </div>


<!-- Nuevo: ticket fijo -->
<div id="ticketContainer"></div>

<div id="compartirCard" style="display:flex; justify-content:center; margin:40px 0;">
  <div id="cardParaDescarga" style="
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
        max-width:600px;
        width:90%;
        padding:30px 20px;
        border-radius:12px;
        background:#fff;
        box-shadow:0 4px 12px rgba(0,0,0,0.15);
        text-align:center;
    ">
    <div id="qrContainer"></div>
    <p id="linkTexto" style="word-wrap: break-word; font-size:16px; color:#333; margin-bottom:20px;"></p>
    <div id="buttonsContainer" style="display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
      <button id="descargarQR" style="background:#000; color:#fff; padding:10px 16px; border:none; border-radius:6px; cursor:pointer;">Descargar QR</button>
      <button id="compartirWhatsApp" style="background:#000; color:#fff; padding:10px 16px; border:none; border-radius:6px; cursor:pointer;">Compartir WhatsApp</button>
    </div>
  </div>
</div>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyqRNtLDpy__ieJM0a0a3KIEIirzXCFLOOVe0h55gzBUNR7y4GyL_JUunfykyTgPfrZ/exec";

// ------------------ OBTENER USERNAME ------------------
let params = new URLSearchParams(window.location.search);
let username = params.get("username");
let userId = params.get("userId"); // opcional si lo pas√°s por URL

if (!username) {
  let path = window.location.pathname.replace(/\/+$/, "");
  const lastSegment = path.substring(path.lastIndexOf("/") + 1);
  if (lastSegment && lastSegment !== "username.html") username = lastSegment;
}
if (!username) alert("Falta username en la URL");
// Mostrar el username en la bienvenida
if (username) {
  document.getElementById("businessName").textContent = username;
}
// ------------------ VARIABLES GLOBALES ------------------
let selectedDate;      // Fecha seleccionada
let turnosData = {};   // Turnos cargados
let profesionales = {}; 
let selectedProfId = null;
let selectedProf = "";
let selectedHora = "";
let selectedHoras = []; // array de horas reservadas
let selectedServicio = null; // servicio elegido


// ------------------ CARGAR LOGO ------------------
  async function cargarLogo(username) {
  try {
    // pedimos al backend los datos del perfil
    const res = await fetch(`${API_URL}?action=getPerfil&username=${username}`);
    const perfil = await res.json();

    console.log("Perfil recibido del backend:", perfil);

    if (perfil.status === "ok") {
      let logoUrl = perfil.logo || "https://www.shutterstock.com/image-illustration/front-view-barber-shop-modern-600nw-723232468.jpg";

      // Si es un link de Drive tipo "https://drive.google.com/file/d/ID/view?usp=..."
      const driveMatch = logoUrl.match(/\/d\/([a-zA-Z0-9_-]+)\//);
      if (driveMatch) {
        const fileId = driveMatch[1];
        // Transformamos en enlace directo compatible con <img>
        logoUrl = `https://drive.google.com/uc?export=view&id=${fileId}`;
      }

      const logo = document.getElementById("userLogo");
      logo.src = logoUrl;
    } else {
      console.log("No se encontr√≥ perfil para", username);
    }
  } catch (e) {
    console.log("Error cargando logo:", e);
  }
}


// ------------------ RENDER CALENDARIO ------------------
function renderCalendario(year, month) {
  const today = new Date();
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const calendarDiv = document.getElementById("calendario");

  // t√≠tulo del mes
  calendarDiv.innerHTML = `<h2>${firstDay.toLocaleString("es-ES",{month:"long", year:"numeric"})}</h2>`;

  // contenedor de d√≠as en fila horizontal
  const diasContainer = document.createElement("div");
  diasContainer.id = "dias";

  const letrasDias = ["D","L","M","M","J","V","S"]; // primeras letras

  let diaCentrar = null; // guardamos qu√© d√≠a centrar

  for (let d = 1; d <= lastDay.getDate(); d++) {
    const fecha = new Date(year, month, d);
    const fechaStr = fecha.toISOString().split("T")[0];
    const letra = letrasDias[fecha.getDay()];

    const dia = document.createElement("div");
    dia.classList.add("dia");

    const diaNumero = document.createElement("div");
    diaNumero.classList.add("dia-numero");
    diaNumero.textContent = d;

    const diaLetra = document.createElement("div");
    diaLetra.classList.add("dia-letra");
    diaLetra.textContent = letra;

    dia.appendChild(diaNumero);
    dia.appendChild(diaLetra);

    if (fecha < new Date(today.getFullYear(), today.getMonth(), today.getDate())) {
      dia.classList.add("bloqueado");
    } else {
      if (
        fecha.getFullYear() === today.getFullYear() &&
        fecha.getMonth() === today.getMonth() &&
        fecha.getDate() === today.getDate()
      ) {
        dia.classList.add("hoy");
        diaCentrar = dia; // en mes actual ‚Üí hoy
      }
      dia.onclick = () => seleccionarDia(dia, fechaStr);
    }

    // si no es el mes actual y a√∫n no tenemos referencia, centramos el 1
    if (!diaCentrar && d === 1) {
      diaCentrar = dia;
    }

    diasContainer.appendChild(dia);
  }

  calendarDiv.appendChild(diasContainer);

  // botones mes anterior/siguiente
  document.getElementById("prevMonth").onclick = () => renderCalendario(year, month - 1);
  document.getElementById("nextMonth").onclick = () => renderCalendario(year, month + 1);

  // üîπ Centrar el d√≠a elegido despu√©s de renderizar
  if (diaCentrar) {
    setTimeout(() => {
      diaCentrar.scrollIntoView({ behavior: "smooth", inline: "center", block: "nearest" });
    }, 100);
  }
}

// ------------------ SELECCIONAR D√çA ------------------
function seleccionarDia(diaDiv, fechaStr) {
  // quitar selecci√≥n anterior
  document.querySelectorAll("#dias .dia.seleccionado").forEach(el => el.classList.remove("seleccionado"));
  // marcar d√≠a seleccionado
  diaDiv.classList.add("seleccionado");
  // cargar turnos
  cargarTurnos(fechaStr);
}
// ------------------ CARGAR TURNOS ------------------
async function cargarTurnos(fechaStr) {
  selectedDate = new Date(fechaStr + "T00:00:00");
  const fechaBonita = selectedDate.toLocaleDateString("es-ES", {
    day: "numeric",
    month: "long",
    year: "numeric"
  });

  const turnosDiv = document.getElementById("turnos");
  turnosDiv.innerHTML = `<h2> ${fechaBonita}</h2><p>Cargando...</p>`;
  document.getElementById("reservaFormContainer").style.display = "none";

  try {
    const res = await fetch(`${API_URL}?username=${username}&fecha=${fechaStr}`);
    const data = await res.json();

    if (data.status !== "ok") {
      turnosDiv.innerHTML = `
        <h2> ${fechaBonita}</h2>
        <p style="color:red;">Error al cargar: ${data.msg || "Error desconocido"}</p>
      `;
      return;
    }

    turnosData = data.turnos;
    profesionales = data.profesionales;

    let html = "";

    if (!turnosData || Object.keys(turnosData).length === 0) {
      html += `<div class="turnos"><p>No hay turnos configurados para esta fecha</p></div>`;
    } else {
      Object.keys(turnosData).forEach(profId => {
        const profObj = turnosData[profId];
        const profConfig = profesionales.find(p => p.profesionalId === profId);
        if (profConfig) {
          profObj.intervalo = parseInt(profConfig.intervalo) || 30;
        }

        html += `<div class="turnos"><h3>${profObj.nombre}</h3>`;

        // --- Servicios ---
        let servicios = [];
        if (profConfig) {
          for (let i = 1; i <= 10; i++) {
            const nombre = profConfig[`servicio${i}`];
            const duracion = profConfig[`tiempo${i}`];
            if (typeof nombre === "string" && nombre.trim() !== "" && duracion) {
              servicios.push({ nombre: nombre.trim(), duracion: parseInt(duracion) });
            }
          }
        }

        if (servicios.length) {
          html += `<label>Servicio: <select data-profid="${profId}" class="select-servicio">
            <option value="">Selecciona un servicio</option>`;
          servicios.forEach(s => {
            html += `<option value="${s.nombre}" data-duracion="${s.duracion}">${s.nombre} (${s.duracion} min)</option>`;
          });
          html += `</select></label>`;
        }

        // --- Turnos ---
        if (!profObj.turnos || profObj.turnos.length === 0) {
          html += "<p>No hay turnos disponibles</p>";
        } else {
          html += `<div class="hora-container">`; // contenedor de grilla 2 columnas
          profObj.turnos.forEach(t => {
            const clase = t.estado === "bloqueado" ? "bloqueado" : "disponible";
            const horaFormateada = t.hora.padStart(5, "0");
            html += `<span 
                        class="hora ${clase}" 
                        data-profid="${profId}" 
                        data-hora="${horaFormateada}">
                        ${horaFormateada}
                     </span>`;
          });
          html += `</div>`; // cierre del contenedor de grilla
        }

        html += `</div>`; // cierre del contenedor .turnos
      });
    }

    turnosDiv.innerHTML = html;
    // listeners turnos
    document.querySelectorAll(".hora.disponible").forEach(span => {
      span.addEventListener("click", () => {
        seleccionarTurno(span.dataset.profid, span.dataset.hora);
      });
    });

    // üîΩ listeners servicios (nuevo con recalculo de disponibilidad)
document.querySelectorAll(".select-servicio").forEach(sel => {
  sel.addEventListener("change", e => {
    const dur = parseInt(e.target.selectedOptions[0].dataset.duracion);
    const profId = e.target.dataset.profid;

    selectedServicio = { nombre: e.target.value, duracion: dur };

    // recalcular la disponibilidad de ese profesional
    recalcularDisponibilidad(profId, dur);
  });
});


  } catch (err) {
    console.error("Error cargando turnos:", err);
    turnosDiv.innerHTML = `
      <h2> ${fechaBonita}</h2>
      <p style="color:red;">No se pudieron cargar los turnos.</p>
    `;
  }
}
// ------------------ NUEVA FUNCI√ìN ------------------
function recalcularDisponibilidad(profId, duracion) {
  const intervalo = turnosData[profId].intervalo || 30; // intervalo real
  const turnos = turnosData[profId].turnos;

  // pasamos a mapa r√°pido para buscar por hora
  const mapa = {};
  turnos.forEach(t => mapa[t.hora] = t.estado);

  turnos.forEach(t => {
    const span = document.querySelector(`.hora[data-profid="${profId}"][data-hora="${t.hora}"]`);
    if (!span) return;

    if (t.estado !== "disponible") {
      span.classList.remove("disponible","selected");
      span.classList.add("bloqueado");
      return;
    }

    // calcular cu√°ntos bloques necesito
    const bloques = Math.ceil(duracion / intervalo);

    // verificar continuidad desde t.hora
    let ok = true;
    let [h,m] = t.hora.split(":").map(Number);

    for (let i=0; i<bloques; i++) {
      const horaStr = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
      if (mapa[horaStr] !== "disponible") {
        ok = false;
        break;
      }
      m += intervalo;
      if (m>=60) { m=0; h++; }
    }

    if (ok) {
      span.classList.remove("bloqueado");
      span.classList.add("disponible");
    } else {
      span.classList.remove("disponible","selected");
      span.classList.add("bloqueado");
    }
  });

  // volver a enganchar listeners solo a los disponibles
  document.querySelectorAll(`.hora.disponible[data-profid="${profId}"]`).forEach(span => {
    span.onclick = () => seleccionarTurno(profId, span.dataset.hora);
  });
}

// ------------------ SELECCIONAR TURNO ------------------
function seleccionarTurno(profId, hora) {
  if (!selectedServicio) {
    alert("Selecciona un servicio primero");
    return;
  }

  const turnosProf = turnosData[profId]?.turnos || [];
  if (!turnosProf.length) return;

  // üîπ calcular intervalo real seg√∫n la grilla
  let intervalo = null;
  if (turnosProf.length > 1) {
    const [h1, m1] = turnosProf[0].hora.split(":").map(Number);
    const [h2, m2] = turnosProf[1].hora.split(":").map(Number);
    intervalo = (h2*60 + m2) - (h1*60 + m1);
  }
  if (!intervalo) {
    alert("No se pudo calcular el intervalo de turnos");
    return;
  }

  // üîπ calcular bloques necesarios seg√∫n duraci√≥n
  const bloques = Math.ceil(selectedServicio.duracion / intervalo);

  // üîπ buscar turnos consecutivos
  const idx = turnosProf.findIndex(t => t.hora === hora);
  if (idx === -1) return;

  const seleccionados = [];
  for (let i = 0; i < bloques; i++) {
    const turno = turnosProf[idx + i];
    if (!turno || turno.estado !== "disponible") {
      alert("No hay turnos consecutivos suficientes para este servicio.");
      return;
    }
    seleccionados.push(turno.hora);
  }

  // üîπ guardar selecci√≥n global
  selectedProfId = profId;
  selectedProf = turnosData[profId].nombre;
  selectedHora = hora;
  selectedHoras = seleccionados;

  // üîπ limpiar selecci√≥n previa
  document.querySelectorAll(".hora.disponible").forEach(el => el.classList.remove("selected"));

  // üîπ marcar selecci√≥n actual
  seleccionados.forEach(h => {
    const span = document.querySelector(`.hora.disponible[data-profid="${profId}"][data-hora="${h}"]`);
    if (span) span.classList.add("selected");
  });

  mostrarFormReserva(selectedProfId, selectedHora);
}

// ------------------ MOSTRAR FORMULARIO ------------------
function mostrarFormReserva(profId, hora) {
  const fechaStr = selectedDate.toISOString().split("T")[0];

  // Crear fecha en formato bonito dd/mm/aaaa
  const fechaBonita = selectedDate.toLocaleDateString("es-AR", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric"
  });

  const formContainer = document.getElementById("reservaFormContainer");
  formContainer.style.display = "block";
  formContainer.innerHTML = `
    <h2>√öltimo paso! </h2><p style="font-size: 12px;">Completa tus datos y confirma la reserva con ${turnosData[profId].nombre} el ${fechaBonita} a las ${hora}
    Servicio: ${selectedServicio.nombre} (${selectedServicio.duracion} min)<br>
    Bloques: ${selectedHoras.join(", ")}</p>
   <form id="reservaForm">
  
  
  <input type="text" id="nombre" name="nombre" placeholder="Nombre" required>
  
  
  <input type="text" id="apellido" name="apellido" placeholder="Apellido" required>
  
  <input type="hidden" name="telefono" value="">
  
  
  <input type="text" id="direccion" name="direccion" placeholder="Direcci√≥n" required>
  
  
  <input type="hidden"  name="fechaNacimiento" value="">
  
  
  <input type="email" id="email" name="email" placeholder="Email" required>
  
  
  <input type="text" id="whatsapp" name="whatsapp" placeholder="Whatsapp" required>
  
  
  <input type="text" id="dni" name="dni" placeholder="DNI" required>
  
  
  <textarea id="comentario" name="comentario" placeholder="Comentario (opcional)"></textarea>
  
  <input type="hidden" name="servicio" value="${selectedServicio.nombre}">
  <input type="hidden" name="extra2" value="">
  <input type="hidden" name="extra3" value="">
  
  <button type="submit"><i class="fas fa-check"></i> Confirmar Reserva</button>
</form>
    <div id="reservaMsg"></div>
  `;

  // üîΩ Bajamos al formulario autom√°ticamente
  formContainer.scrollIntoView({ behavior: "smooth" });
  
 // ------------------ Enviar reserva ------------------
  document.getElementById("reservaForm").onsubmit = async function(event){
    event.preventDefault();
    const form = this;
    const submitButton = form.querySelector("button[type='submit']");
    
    // Bloquear bot√≥n para evitar m√∫ltiples clics
    submitButton.disabled = true;
    submitButton.innerText = "Reservando...";
    const reservaMsg = document.getElementById("reservaMsg");
    reservaMsg.innerHTML = "";

    const formData = new FormData(form);
    
    const dataToSend = {
      username,
      profesional: selectedProf,
      profesionalId: selectedProfId,
      fecha: fechaStr,
      hora: selectedHora,          // solo la primera
      horas: selectedHoras.join(","),  // todas en string separadas por coma
      nombre: formData.get("nombre"),
      apellido: formData.get("apellido"),
      telefono: formData.get("telefono"),
      direccion: formData.get("direccion"),
      fechaNacimiento: formData.get("fechaNacimiento"),
      email: formData.get("email"),
      whatsapp: formData.get("whatsapp"),
      dni: formData.get("dni"),
      comentario: formData.get("comentario"),
      horas: selectedHoras,
      servicio: selectedServicio.nombre,
     
      extra2: formData.get("extra2"),
      extra3: formData.get("extra3")
    };
    console.log("Voy a enviar reserva:", dataToSend);
    const res = await fetch(API_URL, {
      method: "POST",
      body: new URLSearchParams({action:"saveReserva", data: JSON.stringify(dataToSend)})
    });
    const result = await res.json();
    console.log("Respuesta del backend:", result);
    if (result.status === "ok") {
  // borro el formulario, pero dejo el contenedor
  document.getElementById("reservaForm").remove();
// Reemplazar "cargando" por el ticket
        reservaMsg.innerHTML = "";
        document.getElementById("ticketContainer").innerHTML = `
          <div class="ticket">
            ${result.ticketHTML}
            <button onclick="window.print()">Imprimir Ticket</button>
          </div>
        `; 
 

  // actualizo turnos
  cargarTurnos(fechaStr);
} else {
  document.getElementById("reservaMsg").innerText =
    "Error al reservar: " + (result.msg || "");

}
  }; 
} 

function hideLoading() {
  const loading = document.getElementById("loadingScreen");
  loading.style.opacity = 0;
  setTimeout(() => loading.remove(), 500);
}

// ------------------ INIT ------------------
document.addEventListener("DOMContentLoaded", async () => {
  // Cargar logo
  await cargarLogo(username);

  // Inicializamos selectedDate al d√≠a de hoy
  selectedDate = new Date();

  // Renderizamos calendario
  renderCalendario(selectedDate.getFullYear(), selectedDate.getMonth());

  // Cargamos turnos del d√≠a actual
  const todayStr = new Date().toISOString().split("T")[0]; // yyyy-mm-dd
  await cargarTurnos(todayStr);

  // Ocultar loading
  hideLoading();

  // Si quer√©s, bajar autom√°ticamente a turnos
  // const turnosDiv = document.getElementById("turnos");
  // if (turnosDiv) turnosDiv.scrollIntoView({ behavior: "smooth" });
});

</script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
function generarQR() {
  const qrContainer = document.getElementById("qrContainer");
  qrContainer.innerHTML = "";
  const urlActual = window.location.href;

  document.getElementById("linkTexto").textContent = urlActual;

  new QRCode(qrContainer, {
    text: urlActual,
    width: 200,
    height: 200,
    colorDark: "#000000",
    colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.H
  });
}

// Generar QR al cargar
document.addEventListener("DOMContentLoaded", generarQR);

// Descargar tarjeta (solo QR + link) centrada y n√≠tida en PC y m√≥vil
document.getElementById("descargarQR").addEventListener("click", function() {
  const card = document.getElementById("cardParaDescarga");
  
  html2canvas(card, { 
    scale: 2,
    width: card.offsetWidth,
    windowWidth: card.scrollWidth,
  }).then(canvas => {
    const link = document.createElement("a");
    link.href = canvas.toDataURL("image/png");
    link.download = "turnox-qr.png";
    link.click();
  });
});

// WhatsApp solo comparte link clicable
document.getElementById("compartirWhatsApp").addEventListener("click", function() {
  const urlActual = window.location.href;
  const texto = encodeURIComponent(`Autogesti√≥n de turno: ${urlActual}`);
  window.open("https://wa.me/?text=" + texto, "_blank");
});
</script>
  
 
</body>
</html>
