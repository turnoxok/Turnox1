<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mi Configuración</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f9; margin:0; padding:20px; }
    h3 { margin:0 0 8px; font-size:1.2rem; }
    .profesional { background:#fff; border-radius:12px; padding:15px; margin-bottom:15px; box-shadow:0 2px 6px rgba(0,0,0,.08); }
    .chips { display:flex; flex-wrap:wrap; gap:6px; margin-top:5px; }
    .chip { background:#4e73df; color:#fff; padding:4px 10px; border-radius:20px; font-size:.85rem; }
    .actions { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; }
    .btn-edit, .btn-danger { padding:8px 12px; border:none; border-radius:8px; cursor:pointer; font-size:.9rem; }
    .btn-edit { background:#36b9cc; color:#fff; }
    .btn-danger { background:#e74a3b; color:#fff; }
    .note { font-size:.9rem; color:#333; }
    .turno { padding:6px 10px; border:1px solid #ddd; border-radius:6px; margin:4px; display:inline-block; cursor:pointer; }
    .turno.disponible { background:#e0ffe0; }
    .turno.bloqueado { background:#ffe0e0; cursor:not-allowed; }
    .turno.seleccionado { background:#4e73df; color:#fff; }
    .msg { color:#e74a3b; font-size:.85rem; margin-top:6px; }
  </style>
</head>
<body>

  <h2>Mis Profesionales</h2>
  <div id="profesionales"></div>

  <script>
    // === Render profesionales con servicios ===
    function renderProfesionales(list){
      const cont = document.getElementById("profesionales");
      if (!list || list.length === 0) {
        cont.innerHTML = `
          <div class="note" style="text-align:center; margin:20px 0; padding:15px; border-radius:12px; background:#ffffff10;">
            No hay profesionales creados.<br>
            <b>Creá uno</b> para acceder a la configuración.
          </div>
        `;
        return;
      }
      cont.innerHTML = "";

      list.forEach(p => {
        const box = document.createElement("div");
        box.className = "profesional";
        const serviciosChips = Array.isArray(p.servicios)
          ? p.servicios.map(s => `<span class="chip">${escapeHtml(s?.nombre||'Servicio')} • ${fmtDur(s?.tiempo)}</span>`).join("")
          : "";

        box.innerHTML = `
          <h3>${escapeHtml(p.nombre||'—')}</h3>
          ${serviciosChips ? `<div class="chips" aria-label="Servicios">${serviciosChips}</div>` : `<div class="mini" style="opacity:.9;text-align:center;margin-top:6px;">Sin servicios cargados</div>`}
          <div class="actions">
            <button class="btn-edit">Configurar Turnos</button>
            <button class="btn-danger btn-clear">Limpiar Turnos</button>
            <button class="btn-danger btn-delete">Eliminar Profesional</button>
          </div>
          <div class="editor" style="display:none"></div>
        `;

        const btnEdit = box.querySelector(".btn-edit");
        const editor = box.querySelector(".editor");

        btnEdit.onclick = () => {
          if (btnEdit.textContent === "Configurar Turnos") {
            abrirEditor(editor, p);
            editor.style.display = "block";
            btnEdit.textContent = "Cerrar";
          } else {
            editor.style.display = "none";
            btnEdit.textContent = "Configurar Turnos";
          }
        };

        box.querySelector(".btn-clear").onclick = () => eliminarTurnos(p.profesionalId);
        box.querySelector(".btn-delete").onclick = () => eliminarProfesional(p.profesionalId);

        cont.appendChild(box);
      });
    }

    // === Abrir editor de turnos ===
    function abrirEditor(editor, profesional){
      editor.innerHTML = "";
      const msgBox = document.createElement("div");
      msgBox.className = "msg";
      editor.appendChild(msgBox);

      // Renderizar turnos del profesional
      if(profesional.turnos && profesional.turnos.length>0){
        profesional.turnos.forEach(t=>{
          const div = document.createElement("div");
          div.className = "turno "+t.estado;
          div.textContent = t.hora;
          div.onclick = ()=>{
            if(t.estado==="bloqueado") return;

            // Calcular si el servicio seleccionado requiere intervalos adicionales
            const servicioSel = profesional.servicios?.[0]; // de momento tomamos el primero
            const minutos = servicioSel?.tiempo || 30; // default 30
            const bloques = minutos/30; // ej: 60min = 2 bloques de 30

            const idx = profesional.turnos.findIndex(x=>x.hora===t.hora);
            let puede = true;
            for(let k=0;k<bloques;k++){
              const sig = profesional.turnos[idx+k];
              if(!sig || sig.estado!=="disponible"){ puede=false; break; }
            }

            if(!puede){
              msgBox.textContent = "El servicio requiere más tiempo y el siguiente turno está ocupado.";
              return;
            }else{
              msgBox.textContent = "";
              // marcar como seleccionados los bloques necesarios
              for(let k=0;k<bloques;k++){
                profesional.turnos[idx+k].estado="seleccionado";
              }
              abrirEditor(editor,profesional); // re-render
            }
          };
          editor.appendChild(div);
        });
      }else{
        editor.innerHTML += `<div class="note">Sin turnos cargados</div>`;
      }
    }

    // === Utils ===
    function escapeHtml(str){
      return str?.toString().replace(/[&<>"']/g, m=>(
        {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]
      )) || "";
    }
    function fmtDur(min){ return min ? min+"min" : "—"; }
  </script>

</body>
</html>
