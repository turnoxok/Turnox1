<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TurnoX - Sistema PRE-PAGO de Turnos On Line</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

  <!-- Fuentes -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Iconos -->
  <link rel="icon" type="image/png" href="https://i.ibb.co/p6Ycq6XC/Turnox-logo.png">
  <link rel="icon" type="image/x-icon" href="favicon.ico">

  <!-- Open Graph -->
  <meta property="og:title" content=">TurnoX - Sistema PRE-PAGO de Turnos On Line" />
  <meta property="og:description" content="Turnero Pro." />
  <meta property="og:image" content="https://i.ibb.co/p6Ycq6XC/Turnox-logo.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:url" content="https://turnox.pro/" />
  <meta property="og:type" content="website" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="TurnoX - Sistema PRE-PAGO de Turnos On Line" />
  <meta name="twitter:description" content="Turnero Pro." />
  <meta name="twitter:image" content="https://i.ibb.co/p6Ycq6XC/Turnox-logo.png" />

  <style>
    html { scroll-behavior: smooth; }
    body {
      font-family: "Montserrat", sans-serif;
      font-optical-sizing: auto;
      font-weight: 400;
      font-style: normal;
      margin: 0;
      padding: 0;
      background-color: #4B2E78;
      color: #fff;
    }
    h1 { text-align: center; margin-bottom: 20px; font-size: 2rem; }

    /* Calendario */
    #calendario {
      margin: 100px auto 10px auto;
      max-width: 600px;
      width: 100%;
      background: #ffffff15;
      background-blend-mode: overlay;
      color: #fff;
      border: 1px solid #ffffff30;
      border-radius: 16px;
      overflow: hidden;
      padding: 15px;
      backdrop-filter: blur(3px);
    }
    #calendario h2 { text-align: center; margin-bottom: 10px; text-transform: capitalize; }
    #calendario table { width: 100%; border-collapse: collapse; }
    #calendario th, #calendario td { width: 14.28%; text-align: center; padding: 10px 0; }
    #calendario td:hover { border-color: #ffffff99; cursor: pointer; border-radius: 10%; }
    #calendario td[style*="not-allowed"] { cursor: not-allowed; color: #999; }
    #calendario td.hoy { border: 2px solid #ffffff99; border-radius: 10%; }
    #calendario td.seleccionado { background-color: #533482; color: #fff; border-radius: 10%; }
    #calendario td.bloqueado { cursor: not-allowed; color: #999; pointer-events: none; }

    #turnos { text-align: center; }

    /* Turnos */
    .turnos {
      margin: 15px auto;
      max-width: 600px;
      text-align: center;
      padding: 15px;
      background: #ffffff15;
      background-blend-mode: overlay;
      color: #fff;
      border: 2px solid #ffffff30;
      border-radius: 16px;
      backdrop-filter: blur(3px);
    }
    .turnos h3 { margin-bottom: 10px; }
    .hora { display: inline-block; margin: 5px; padding: 8px 12px; border-radius: 10px; font-weight: 600; transition: all 0.2s; }
    .hora.disponible { background: #ffffff99; color: #533482; border-radius: 10px; }
    .hora.disponible:hover { background: #533482; color: #fff; cursor: pointer; transform: translateY(-2px); }
    .hora.bloqueado { background: #D2B8FF95; color: #F7F7F7; cursor: not-allowed; text-decoration: line-through; opacity: 0.6; border-radius: 10px; }
    .hora.selected { background-color: #533482; color: #fff; transform: translateY(-2px); }

    /* Formulario de reserva */
    #reservaFormContainer {
      margin: 20px auto;
      max-width: 600px;
      background: #ffffff15;
      background-blend-mode: overlay;
      color: #fff;
      border: 2px solid #ffffff30;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      backdrop-filter: blur(3px);
      display: none;
    }
    #reservaForm { display: flex; flex-direction: column; align-items: center; }
    #reservaForm input,
    #reservaForm textarea,
    #reservaForm button {
      width: 90%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 16px;
      border: 1px solid #ffffff40;
      font-family: 'Montserrat', sans-serif;
      text-align: center;
      box-sizing: border-box;
      background-color: #ffffff25;
      color: #fff;
    }
    #reservaForm button {
      background-color: #533482;
      color: #fff;
      border: none;
      border-radius: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    #reservaForm button:hover { background-color: #452a7a; transform: translateY(-2px); }
    #reservaMsg { margin-top: 10px; text-align: center; font-weight: 600; }
    #reservaForm label i {
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      margin-right: 5px;
      display: inline-block;
      vertical-align: middle;
      color: inherit;
    }
    #reservaForm label { display: flex; align-items: center; }

    .ticket {
      font-family: "Montserrat", sans-serif;
      font-weight: 400;
      margin: 20px auto;
      max-width: 500px;
      background: #ffffff25;
      background-blend-mode: overlay;
      color: #fff;
      border: 2px solid #ffffff40;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      text-align: left;
    }
    .ticket h2 {
      font-weight: 700;
      text-align: center;
      color: #fff;
      margin-bottom: 15px;
    }
    .ticket p { margin: 6px 0; font-size: 0.95rem; }
    .ticket button {
      margin-top: 15px;
      padding: 14px 16px;
      border: none;
      border-radius: 10px;
      background: #533482;
      color: #fff;
      cursor: pointer;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .ticket button:hover { background: #5F48D7; }

    #floatingLogo {
      height: 100%;
      display: flex;
      align-items: center;
      margin-left: 5px;
      max-width: 60%;
      transition: transform 0.9s ease;
      transform: translateX(-150px);
    }
    #floatingLogo img { max-height: 60px; max-width: 100%; object-fit: contain; display: block; }

    header {
      position: fixed; top: 0; left: 0; width: 100%; height: 70px;
      border-bottom: 1px solid #ddd;
      display: flex; justify-content: space-between; align-items: center;
      padding: 0 10px; box-sizing: border-box; z-index: 1000;
      background:
        linear-gradient(135deg, #D2B8FF 0%, #fff 25%, #F4EDFF 50%, #fff 75%, #D2B8FF 100%),
        repeating-linear-gradient(0deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 2px, transparent 2px, transparent 4px);
      background-blend-mode: overlay;
    }
    .login-btn {
      padding: 8px 16px; background-color: #575757; color: white;
      border: none; border-radius: 5px; font-size: 14px; cursor: pointer;
      text-decoration: none; transition: background 0.3s ease;
    }
    .login-btn:hover { background-color: #533482; }

    /* Fondo decorativo */
    .grid { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; gap: 30px; justify-content: center; align-items: center; z-index: -1; pointer-events: none; }
    .col { display: flex; flex-direction: column; gap: 20px; }
    .rect { width: 80px; height: 120px; border: 2px solid #5F48D750; border-radius: 12px; }
    .rect.filled { background: #412866; }
    .down .rect { animation: moveDown 20s linear infinite; }
    .up .rect { animation: moveUp 20s linear infinite; }
    @keyframes moveDown { 0% { transform: translateY(-150vh); opacity: 0; } 10% { opacity: 1; } 100% { transform: translateY(150vh); opacity: 0; } }
    @keyframes moveUp { 0% { transform: translateY(150vh); opacity: 0; } 10% { opacity: 1; } 100% { transform: translateY(-150vh); opacity: 0; } }

    [hidden] { display: none !important; }

    input::placeholder, textarea::placeholder { color: #fff; opacity: 1; font-family: "Montserrat", sans-serif; }

    /* ====== NUEVO: selector de servicio por profesional ====== */
    .svc-picker {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      margin: 8px 0 4px 0;
      flex-wrap: wrap;
    }
    .svc-picker label { font-weight: 600; }
    .svc-picker select {
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid #ffffff40;
      background: #ffffff25;
      color: #fff;
      font-family: "Montserrat", sans-serif;
    }
    .svc-picker small { opacity: .9; }
    .svc-msg {
      text-align: center;
      font-size: 0.95rem;
      color: #ffcccc;
      min-height: 1.2em;
      margin-bottom: 4px;
    }
    .svc-hint {
      font-size: .9rem;
      opacity: .9;
      display: block;
      margin-top: 4px;
    }

    @media(max-width: 650px){
      #calendario, .turnos, #reservaFormContainer { width: 80%; padding: 10px; }
      .hora { padding: 6px 10px; font-size: 0.9rem; }
    }
  </style>
</head>
<body>
  <div class="grid">
    <div class="col down">
      <div class="rect filled"></div><div class="rect"></div><div class="rect"></div><div class="rect"></div><div class="rect"></div>
      <div class="rect filled"></div><div class="rect"></div><div class="rect"></div><div class="rect"></div><div class="rect"></div>
      <div class="rect"></div><div class="rect"></div>
    </div>
    <div class="col up">
      <div class="rect"></div><div class="rect filled"></div><div class="rect"></div><div class="rect"></div><div class="rect"></div>
      <div class="rect"></div><div class="rect"></div><div class="rect"></div><div class="rect"></div><div class="rect"></div>
      <div class="rect"></div><div class="rect filled"></div>
    </div>
    <div class="col down">
      <div class="rect"></div><div class="rect"></div><div class="rect filled"></div><div class="rect"></div><div class="rect"></div>
      <div class="rect"></div><div class="rect"></div><div class="rect"></div><div class="rect filled"></div><div class="rect"></div>
      <div class="rect"></div><div class="rect"></div>
    </div>
  </div>

  <header>
    <div id="floatingLogo"><div class="logo-container"><img id="userLogo"></div></div>
    <a href="login.html" class="login-btn">Acceso</a>
  </header>

  <div id="calendario"></div>

  <div style="display:flex; gap:20px; align-items:center; justify-content:center;">
    <button id="prevMonth" style="display:flex; align-items:center; gap:6px; padding:0; background:none; border:none; color:#F4EDFF; cursor:pointer; font-size:16px;">
      <svg xmlns="http://www.w3.org/2000/svg" width="30" height="18" viewBox="0 0 60 24" fill="none" stroke="#F4EDFF" stroke-width="2" stroke-linecap="butt" stroke-linejoin="miter">
        <line x1="58" y1="12" x2="8" y2="12"></line><polyline points="16,4 2,12 16,20"></polyline>
      </svg>
      Mes anterior
    </button>
    <button id="nextMonth" style="display:flex; align-items:center; gap:6px; padding:0; background:none; border:none; color:#F4EDFF; cursor:pointer; font-size:16px;">
      Mes siguiente
      <svg xmlns="http://www.w3.org/2000/svg" width="30" height="18" viewBox="0 0 60 24" fill="none" stroke="#F4EDFF" stroke-width="2" stroke-linecap="butt" stroke-linejoin="miter">
        <line x1="2" y1="12" x2="52" y2="12"></line><polyline points="44,4 58,12 44,20"></polyline>
      </svg>
    </button>
  </div>

  <div id="turnos"></div>
  <div id="reservaFormContainer"></div>

  <!-- Ticket -->
  <div id="ticketContainer"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxKhvDjAMU0HA6KOybXfIBWMMvin7Mad9HScnJniGK90g7jdV3z54mmaPlo0I1elk7pMA/exec";

    // ------------------ OBTENER USERNAME ------------------
    let params = new URLSearchParams(window.location.search);
    let username = params.get("username");
    let userId = params.get("userId"); // opcional

    if (!username) {
      let path = window.location.pathname.replace(/\/+$/, "");
      const lastSegment = path.substring(path.lastIndexOf("/") + 1);
      if (lastSegment && lastSegment !== "username.html") username = lastSegment;
    }
    if (!username) alert("Falta username en la URL");

    // ------------------ VARIABLES GLOBALES ------------------
    let selectedDate;            // Fecha seleccionada
    let turnosData = {};         // Turnos cargados por profesional
    let profesionales = [];      // Lista con metadatos de profesionales (puede incluir servicios)
    let profMetaById = {};       // Mapa profId -> { profesionalId, nombre, servicios? }
    let profIntervals = {};      // Mapa profId -> intervalo (min) inferido para el día
    let selectedProfId = null;
    let selectedProf = "";
    let selectedHora = "";
    let selectedService = null;  // { name, mins, blocks, interval } o null

    // ------------------ CARGAR LOGO ------------------
    async function cargarLogo(username) {
      try {
        const res = await fetch(`${API_URL}?action=getPerfil&username=${username}`);
        const perfil = await res.json();
        if (perfil.status === "ok") {
          let logoUrl = perfil.logo || "https://i.ibb.co/p6Ycq6XC/Turnox-logo.png";
          const driveMatch = logoUrl.match(/\/d\/([a-zA-Z0-9_-]+)\//);
          if (driveMatch) {
            const fileId = driveMatch[1];
            logoUrl = `https://drive.google.com/uc?export=view&id=${fileId}`;
          }
          const logo = document.getElementById("userLogo");
          logo.src = logoUrl;
        }
      } catch (e) {
        console.log("Error cargando logo:", e);
      }
    }

    // ------------------ RENDER CALENDARIO ------------------
    function renderCalendario(year, month) {
      const today = new Date();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const calendarDiv = document.getElementById("calendario");
      calendarDiv.innerHTML = `<h2>${firstDay.toLocaleString("es-ES",{month:"long", year:"numeric"})}</h2>`;

      let table = "<table><tr>";
      const diasSemana = ["Dom","Lun","Mar","Mié","Jue","Vie","Sáb"];
      diasSemana.forEach(d => table += `<th>${d}</th>`);
      table += "</tr><tr>";

      for (let i = 0; i < firstDay.getDay(); i++) table += "<td></td>";

      for (let d = 1; d <= lastDay.getDate(); d++) {
        const fecha = new Date(year, month, d);
        const fechaStr = fecha.toISOString().split("T")[0];
        let clases = "";

        // Pasado = bloqueado
        if (fecha < new Date(today.getFullYear(), today.getMonth(), today.getDate())) {
          clases = "bloqueado";
          table += `<td class="${clases}">${d}</td>`;
        } else {
          if (
            fecha.getFullYear() === today.getFullYear() &&
            fecha.getMonth() === today.getMonth() &&
            fecha.getDate() === today.getDate()
          ) {
            clases += (clases ? " " : "") + "hoy";
          }
          table += `<td class="${clases}" onclick="seleccionarDia(this, '${fechaStr}')">${d}</td>`;
        }
        if (fecha.getDay() === 6 && d !== lastDay.getDate()) table += "</tr><tr>";
      }

      table += "</tr></table>";
      calendarDiv.innerHTML += table;

      document.getElementById("prevMonth").onclick = () => { renderCalendario(year, month - 1); };
      document.getElementById("nextMonth").onclick = () => { renderCalendario(year, month + 1); };
    }

    // ------------------ SELECCIONAR DÍA ------------------
    function seleccionarDia(td, fechaStr) {
      document.querySelectorAll("#calendario td.seleccionado").forEach(el => el.classList.remove("seleccionado"));
      td.classList.add("seleccionado");
      cargarTurnos(fechaStr);
    }

    // ------------------ UTILS TIEMPO ------------------
    function toMinutes(hhmm) { const [h,m]=hhmm.split(":").map(n=>parseInt(n,10)); return h*60+m; }
    function addMinutes(hhmm, mins) { const t = toMinutes(hhmm)+mins; const h = Math.floor(t/60); const m = t % 60; return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0"); }
    function inferInterval(turnos) {
      const times = (turnos||[]).map(t => (t?.hora||"").padStart(5,"0")).filter(Boolean).sort();
      let minDiff = Infinity;
      for (let i=1;i<times.length;i++){
        const d = toMinutes(times[i]) - toMinutes(times[i-1]);
        if (d>0 && d<minDiff) minDiff = d;
      }
      if (!isFinite(minDiff) || minDiff<=0) minDiff = 30;
      return minDiff;
    }
    function fmtDur(mins){
      const m = parseInt(mins,10);
      if (isNaN(m)) return "—";
      if (m < 60) return `${m} min`;
      const h = Math.floor(m/60), r = m%60;
      return r ? `${h}h ${r} min` : `${h}h`;
    }
    function escapeHtml(str){ return String(str||"").replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[s])); }

    // ------------------ CARGAR TURNOS ------------------
    async function cargarTurnos(fechaStr) {
      selectedDate = new Date(fechaStr + "T00:00:00");
      selectedProfId = null;
      selectedProf = "";
      selectedHora = "";
      selectedService = null;

      const fechaBonita = selectedDate.toLocaleDateString("es-ES", { day: "numeric", month: "long", year: "numeric" });
      const turnosDiv = document.getElementById("turnos");
      turnosDiv.innerHTML = `<h2> ${fechaBonita}</h2><p>Cargando...</p>`;
      document.getElementById("reservaFormContainer").style.display = "none";
      document.getElementById("ticketContainer").innerHTML = "";

      try {
        const res = await fetch(`${API_URL}?username=${username}&fecha=${fechaStr}`);
        const data = await res.json();
        if (data.status !== "ok") {
          turnosDiv.innerHTML = `<h2> ${fechaBonita}</h2><p style="color:red;">Error al cargar: ${data.msg || "Error desconocido"}</p>`;
          return;
        }

        turnosData = data.turnos || {};
        profesionales = data.profesionales || [];
        profMetaById = {};
        (profesionales||[]).forEach(p => { profMetaById[p.profesionalId] = p; });

        let html = "";
        if (!turnosData || Object.keys(turnosData).length === 0) {
          html += `<div class="turnos"><p>No hay turnos configurados para esta fecha</p></div>`;
        } else {
          Object.keys(turnosData).forEach(profId => {
            const profObj = turnosData[profId];
            const meta = profMetaById[profId] || {};
            const servicios = Array.isArray(meta.servicios) ? meta.servicios : [];

            // inferir intervalo para este profesional y día
            profIntervals[profId] = inferInterval(profObj.turnos || []);

            html += `<div class="turnos" data-profid="${profId}">
                      <h3>${escapeHtml(profObj.nombre||meta.nombre||"Profesional")}</h3>`;

            // selector de servicio si existen
            if (servicios.length) {
              html += `
                <div class="svc-picker">
                  <label for="svc_${profId}">Servicio</label>
                  <select id="svc_${profId}">
                    <option value="" selected disabled>Elegí servicio</option>
                    ${servicios.map(s => `
                      <option value="${parseInt(s?.tiempo||0,10)}" data-name="${escapeHtml(s?.nombre||'Servicio')}">
                        ${escapeHtml(s?.nombre||'Servicio')} • ${fmtDur(s?.tiempo)}
                      </option>
                    `).join("")}
                  </select>
                  <small class="svc-hint">Obligatorio para reservar</small>
                </div>
                <div class="svc-msg" id="svcmsg_${profId}"></div>
              `;
            } else {
              html += `<div class="svc-msg" id="svcmsg_${profId}"></div>`;
            }

            if (!profObj.turnos || profObj.turnos.length === 0) {
              html += "<p>No hay turnos disponibles</p>";
            } else {
              profObj.turnos.forEach(t => {
                const clase = t.estado === "bloqueado" ? "bloqueado" : "disponible";
                const horaFormateada = String(t.hora || "").padStart(5, "0");
                html += `<span class="hora ${clase}" data-profid="${profId}" data-hora="${horaFormateada}">${horaFormateada}</span>`;
              });
            }
            html += `</div>`;
          });
        }

        turnosDiv.innerHTML = html;

        // listeners
        document.querySelectorAll(".hora.disponible").forEach(span => {
          span.addEventListener("click", () => {
            seleccionarTurno(span.dataset.profid, span.dataset.hora);
          });
        });

      } catch (err) {
        console.error("Error cargando turnos:", err);
        turnosDiv.innerHTML = `<h2> ${fechaBonita}</h2><p style="color:red;">No se pudieron cargar los turnos.</p>`;
      }
    }

    // ------------------ SELECCIONAR TURNO (con validación de servicio y bloques) ------------------
    function seleccionarTurno(profId, hora) {
      selectedProfId = profId;
      selectedProf = turnosData[profId]?.nombre || profMetaById[profId]?.nombre || "";
      selectedHora = hora;

      const statusEl = document.getElementById(`svcmsg_${profId}`);
      const servicios = profMetaById[profId]?.servicios || [];
      const sel = document.getElementById(`svc_${profId}`);

      // si hay servicios configurados, es obligatorio elegir uno
      let svcName = null, svcMins = null;
      if (servicios.length) {
        if (!sel || !sel.value) {
          if (statusEl) statusEl.textContent = "Elegí un servicio para continuar.";
          return;
        }
        svcMins = parseInt(sel.value, 10);
        const opt = sel.options[sel.selectedIndex];
        svcName = opt?.getAttribute("data-name") || opt?.textContent || "Servicio";
      }

      const interval = profIntervals[profId] || 30;
      const blocks = Math.max(1, Math.ceil((svcMins || interval) / interval));

      // limpiar selección previa
      document.querySelectorAll(".hora.disponible").forEach(el => el.classList.remove("selected"));

      // chequear bloques consecutivos necesarios
      let ok = true, missingAt = null, neededTimes = [];
      let current = hora;
      for (let k=0; k<blocks; k++) {
        neededTimes.push(current);
        const el = document.querySelector(`.hora.disponible[data-profid="${profId}"][data-hora="${current}"]`);
        if (!el) { ok = false; missingAt = current; break; }
        current = addMinutes(current, interval);
      }

      if (!ok) {
        if (statusEl) statusEl.textContent = `Este servicio requiere ${svcMins} min. El turno ${missingAt} no está disponible.`;
        return;
      } else {
        if (statusEl) statusEl.textContent = "";
        neededTimes.forEach(t => {
          const el = document.querySelector(`.hora.disponible[data-profid="${profId}"][data-hora="${t}"]`);
          if (el) el.classList.add("selected");
        });
      }

      selectedService = svcName ? { name: svcName, mins: svcMins, blocks, interval } : null;
      mostrarFormReserva(selectedProfId, selectedHora, selectedService);
    }

    // ------------------ MOSTRAR FORMULARIO ------------------
    function mostrarFormReserva(profId, hora, service) {
      const fechaStr = selectedDate.toISOString().split("T")[0];
      const fechaBonita = selectedDate.toLocaleDateString("es-AR", { day: "2-digit", month: "2-digit", year: "numeric" });

      const formContainer = document.getElementById("reservaFormContainer");
      formContainer.style.display = "block";

      const svcText = service ? ` • Servicio: <b>${escapeHtml(service.name)}</b> (${service.mins} min)` : "";
      formContainer.innerHTML = `
        <h2>¡Último paso!</h2>
        <p style="font-size: 12px;">
          Completá tus datos y confirmá la reserva con <b>${escapeHtml(turnosData[profId]?.nombre || "")}</b>
          el ${fechaBonita} a las ${hora}${svcText}
        </p>

        <form id="reservaForm">
          <input type="text" id="nombre" name="nombre" placeholder="Nombre" required>
          <input type="text" id="apellido" name="apellido" placeholder="Apellido" required>
          <input type="hidden" name="telefono" value="">
          <input type="text" id="direccion" name="direccion" placeholder="Dirección" required>
          <input type="hidden" name="fechaNacimiento" value="">
          <input type="email" id="email" name="email" placeholder="Email" required>
          <input type="text" id="whatsapp" name="whatsapp" placeholder="Whatsapp" required>
          <input type="text" id="dni" name="dni" placeholder="DNI" required>
          <textarea id="comentario" name="comentario" placeholder="Comentario (opcional)"></textarea>
          <input type="hidden" name="extra1" value="${service ? escapeHtml(`${service.name} (${service.mins} min)`) : ""}">
          <input type="hidden" name="extra2" value="">
          <input type="hidden" name="extra3" value="">
          <button type="submit"><i class="fas fa-check"></i> Confirmar Reserva</button>
        </form>
        <div id="reservaMsg"></div>
      `;

      formContainer.scrollIntoView({ behavior: "smooth" });

      // enviar reserva
      document.getElementById("reservaForm").onsubmit = async function(event){
        event.preventDefault();
        const form = this;
        const submitButton = form.querySelector("button[type='submit']");
        submitButton.disabled = true;
        submitButton.innerText = "Reservando...";
        const reservaMsg = document.getElementById("reservaMsg");
        reservaMsg.innerHTML = "";

        const formData = new FormData(form);
        const dataToSend = {
          username,
          profesional: selectedProf,
          profesionalId: selectedProfId,
          fecha: fechaStr,
          hora: selectedHora,
          nombre: formData.get("nombre"),
          apellido: formData.get("apellido"),
          telefono: formData.get("telefono"),
          direccion: formData.get("direccion"),
          fechaNacimiento: formData.get("fechaNacimiento"),
          email: formData.get("email"),
          whatsapp: formData.get("whatsapp"),
          dni: formData.get("dni"),
          comentario: formData.get("comentario"),
          extra1: formData.get("extra1"),
          extra2: formData.get("extra2"),
          extra3: formData.get("extra3")
        };

        try {
          const res = await fetch(API_URL, {
            method: "POST",
            body: new URLSearchParams({action:"saveReserva", data: JSON.stringify(dataToSend)})
          });
          const result = await res.json();

          if (result.status === "ok") {
            document.getElementById("reservaForm").remove();
            reservaMsg.innerHTML = "";
            document.getElementById("ticketContainer").innerHTML = `
              <div class="ticket">
                ${result.ticketHTML}
                <button onclick="window.print()">Imprimir Ticket</button>
              </div>
            `;
            // refrescar turnos del día
            cargarTurnos(fechaStr);
          } else {
            reservaMsg.innerText = "Error al reservar: " + (result.msg || "");
          }
        } catch (err) {
          reservaMsg.innerText = "Error de conexión al reservar.";
          console.error(err);
        } finally {
          submitButton.disabled = false;
          submitButton.innerText = "Confirmar Reserva";
        }
      };
    }

    // ------------------ INIT ------------------
    document.addEventListener("DOMContentLoaded", () => {
      cargarLogo(username);
      selectedDate = new Date();
      renderCalendario(selectedDate.getFullYear(), selectedDate.getMonth());
      const todayStr = selectedDate.toLocaleDateString("fr-CA"); // yyyy-mm-dd local
      cargarTurnos(todayStr).then(() => {
        const turnosDiv = document.getElementById("turnos");
        if (turnosDiv) turnosDiv.scrollIntoView({ behavior: "smooth" });
      });
    });
  </script>

  <script>
    setTimeout(() => { document.getElementById('floatingLogo').style.transform = 'translateX(0)'; }, 4000);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</body>
</html>
