<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel TurnoX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="color-scheme" content="light">
  <meta name="supported-color-schemes" content="light">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="https://i.ibb.co/p6Ycq6XC/Turnox-logo.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
   :root { color-scheme: light only; }
   body {
     font-family: "Montserrat", sans-serif;
     background-color: #4B2E78;
     color: #fff;
     margin: 0;
     padding: 0;
   }
   /* === estilos existentes (recorté lo innecesario para no repetir) === */
   .header-info { position: absolute; top: 15px; right: 15px; display: flex; gap: 15px; align-items: center; }
   .user-pill { padding: 6px 12px; border-radius: 999px; font-size: 14px; background: #ffffff25; border: 1px solid #ffffff40; }
   .creditos-info { display: flex; gap: 6px; align-items: center; padding: 6px 10px; border-radius: 999px; background: #ffffff25; border: 1px solid #ffffff40; font-size: 14px; }

   .container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; gap: 20px; text-align: center; }

   .cantidad-wrapper { display: flex; gap: 10px; align-items: center; }
   .cantidad-btn { background: #25213C; color: #5F48D7; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; }
   #cantidadCreditos { font-family: "Montserrat"; width: 160px; text-align: center; font-size: 80px; background: none; border: none; color: #fff; }
   .total-box { font-size: 18px; font-weight: bold; }
   .btn-comprar { font-family: "Montserrat"; background: #25213C; color: #5F48D7; border: none; padding: 12px 70px; border-radius: 0 0 20px 20px; cursor: pointer; font-size: 16px; }

   .descuento-wrapper { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-top: 15px; }
   .descuento-wrapper input { padding: 8px; border-radius: 8px; border: none; font-size: 14px; text-align: center; }
   .descuento-aplicado { font-size: 16px; font-weight: bold; color: #5F48D7; }
  </style>
</head>
<body>

<div class="header-info">
  <h2 class="user-pill">¡Hola! <span id="usernameDisplay"></span></h2>
  <div class="creditos-info">
    <i class="fa fa-coins"></i>
    <span id="creditosActuales">Cargando...</span>
  </div>
</div>

<div class="container">
  <div class="cantidad-wrapper">
    <button id="btnMenos" class="cantidad-btn">-</button>
    <input type="number" id="cantidadCreditos" min="0" value="10" step="10">
    <button id="btnMas" class="cantidad-btn">+</button>
  </div>

  <p class="total-box">Total a pagar: <span id="totalPagar">$1700</span></p>

  <!-- Campo de descuento -->
  <div class="descuento-wrapper">
    <input type="text" id="codigoDescuento" placeholder="Código de descuento">
    <button onclick="aplicarDescuento()">Aplicar</button>
    <p class="descuento-aplicado" id="totalConDescuento" hidden></p>
  </div>

  <button class="btn-comprar" onclick="comprarCreditos()">Agregar + Créditos</button>
</div>

<!-- nav inferior (recortado por espacio) -->
<div class="bottom-nav">
  <a href="#" class="nav-item active" id="btnCreditos"><i class="fa fa-plus-circle"></i><span>Créditos</span></a>
  <a href="#" class="nav-item" id="btnConfig"><i class="fa fa-tasks"></i><span>Config.</span></a>
  <a href="#" class="nav-item" id="btnClientes"><i class="fa fa-user"></i><span>Clientes</span></a>
  <a href="#" class="nav-item" id="btnTurnos"><i class="fa fa-calendar"></i><span>Turnos</span></a>
  <a href="#" class="nav-item" id="btnPerfil"><i class="fa fa-upload"></i><span>Logo</span></a>
  <a href="#" class="nav-item" id="btnLogout"><i class="fa fa-sign-out-alt"></i><span>Salir</span></a>
</div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwIRxWQYDBRLf0j6Nba9RR0KRQ4TJtv-3VrBNCb-pRa03TJuW46ohxTT1Q9ptqZzg2g/exec";
let username, userId;
const precioUnitario = 170;
let descuentoAplicado = null; // porcentaje o monto

function init(data) {
  username = data.username;
  userId = data.userId;
  document.getElementById("usernameDisplay").innerText = username;

  fetch(`${WEBAPP_URL}?action=getCreditos&username=${encodeURIComponent(username)}`)
    .then(r => r.json())
    .then(data => {
      document.getElementById("creditosActuales").innerText = data.creditos;
    });
}

function actualizarTotal() {
  const cantidad = parseInt(document.getElementById("cantidadCreditos").value) || 0;
  const total = cantidad * precioUnitario;
  document.getElementById("totalPagar").textContent = `$${total}`;

  if (descuentoAplicado) {
    const totalConDescuento = Math.round(total * (1 - descuentoAplicado));
    document.getElementById("totalConDescuento").hidden = false;
    document.getElementById("totalConDescuento").textContent = `Con descuento: $${totalConDescuento}`;
  }
}

function aplicarDescuento() {
  const codigo = document.getElementById("codigoDescuento").value.trim();
  if (!codigo) return alert("Ingrese un código");

  fetch(`${WEBAPP_URL}?action=validarCodigo&codigo=${encodeURIComponent(codigo)}`)
    .then(r => r.json())
    .then(res => {
      if (res.valido) {
        descuentoAplicado = res.descuento; // ej: 0.2 = 20%
        actualizarTotal();
      } else {
        descuentoAplicado = null;
        document.getElementById("totalConDescuento").hidden = true;
        alert("Código inválido");
      }
    });
}

function comprarCreditos() {
  const cantidad = parseInt(document.getElementById("cantidadCreditos").value, 10);
  if (!cantidad || cantidad <= 0) return alert("Cantidad inválida");
  const codigo = document.getElementById("codigoDescuento").value.trim();

  fetch(`${WEBAPP_URL}?action=crearPreferencia&username=${encodeURIComponent(username)}&userId=${encodeURIComponent(userId)}&cantidad=${cantidad}&codigo=${encodeURIComponent(codigo)}`)
    .then(r => r.json())
    .then(data => {
      if (data.url) window.location.href = data.url;
      else alert("Error al generar link de pago");
    });
}

document.addEventListener("DOMContentLoaded", () => {
  actualizarTotal();
  document.getElementById("btnMenos").addEventListener("click", () => { document.getElementById("cantidadCreditos").stepDown(); actualizarTotal(); });
  document.getElementById("btnMas").addEventListener("click", () => { document.getElementById("cantidadCreditos").stepUp(); actualizarTotal(); });
  document.getElementById("cantidadCreditos").addEventListener("input", actualizarTotal);

  // Protege acceso
  const storedUserId = localStorage.getItem("userId");
  const storedUsername = localStorage.getItem("username");
  if (!storedUserId || !storedUsername) window.location.href = "index.html";
  userId = storedUserId; username = storedUsername;
  init({ username, userId });
});
</script>
</body>
</html>
