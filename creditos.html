<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel TurnoX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="color-scheme" content="light">
  <meta name="supported-color-schemes" content="light">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="https://i.ibb.co/p6Ycq6XC/Turnox-logo.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    :root { color-scheme: light only; }
    body {
      font-family: "Montserrat", sans-serif;
      background-color: #4B2E78;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    /* ...todo tu CSS igual... */

    /* Total */
    .total-box {
      font-size: 18px;
      font-weight: bold;
      margin-top: 10px;
    }
    .precio-descuento {
      font-size: 16px;
      color: #5F48D7;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header-info">
    <h2 class="user-pill">¡Hola! <span id="usernameDisplay"></span></h2>
    <div class="creditos-info">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path fill="currentColor" d="M17.47 8.893C18.886 8.185..."/></svg>
      <span id="creditosActuales">Cargando...</span>
    </div>
  </div>

  <div class="container">
    <div class="cantidad-wrapper">
      <div class="floating-tab">
        <button onclick="toggleUserTab()">Ver Mi Sitio</button>
        <div class="tab-content" id="tabContent">
          <a id="userLink" href="#" target="_blank">https://turnox.pro/username</a>
        </div>
      </div>
      <button id="btnMenos" class="cantidad-btn">-</button>
      <input type="number" id="cantidadCreditos" min="0" value="10" step="10">
      <button id="btnMas" class="cantidad-btn">+</button>
    </div>

    <label for="codigoDescuento">Código de descuento</label>
    <input type="text" id="codigoDescuento" placeholder="Ej: HAIR20" class="input" />

    <p class="total-box">
      Total normal: <span id="totalNormal">$0</span><br>
      <span id="precioConDescuento" class="precio-descuento" hidden></span>
    </p>

    <button class="btn-comprar" onclick="comprarCreditos()">Agregar + Créditos</button>
  </div>

  <!-- nav inferior -->
  <div class="bottom-nav">
    <a href="#" class="nav-item active" id="btnCreditos"><i class="fa fa-plus-circle"></i><span>Créditos</span></a>
    <a href="#" class="nav-item" id="btnConfig"><i class="fa fa-tasks"></i><span>Config.</span></a>
    <a href="#" class="nav-item" id="btnClientes"><i class="fa fa-user"></i><span>Clientes</span></a>
    <a href="#" class="nav-item" id="btnTurnos"><i class="fa fa-calendar"></i><span>Turnos</span></a>
    <a href="#" class="nav-item" id="btnPerfil"><i class="fa fa-upload"></i><span>Logo</span></a>
    <a href="#" class="nav-item" id="btnLogout"><i class="fa fa-sign-out-alt"></i><span>Salir</span></a>
  </div>

  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbw2uL_hc0ECnjR_TgAf14shEjFHYAP0qorj4P3bgq_CeTOKwld2C54uJip3_Ihxu1df/exec";
    let username, userId;
    const precioUnitario = 170;

    function init(data) {
      username = data.username;
      userId = data.userId;
      document.getElementById("usernameDisplay").innerText = username;

      fetch(`${WEBAPP_URL}?action=getCreditos&username=${encodeURIComponent(username)}`)
        .then(r => r.json())
        .then(data => {
          document.getElementById("creditosActuales").innerText = data.creditos;
        });
    }

    function actualizarTotal() {
      const cantidad = parseInt(document.getElementById("cantidadCreditos").value) || 1;
      const total = cantidad * precioUnitario;
      document.getElementById("totalNormal").textContent = `$${total}`;

      const codigo = document.getElementById("codigoDescuento").value.trim().toUpperCase();
      const precioDescuento = document.getElementById("precioConDescuento");

      // Ejemplo: 20% descuento si código = HAIR20
      if (codigo === "HAIR20") {
        const totalDescuento = Math.round(total * 0.8);
        precioDescuento.textContent = `Con descuento: $${totalDescuento}`;
        precioDescuento.hidden = false;
      } else {
        precioDescuento.hidden = true;
      }
    }

    function comprarCreditos() {
      const cantidad = parseInt(document.getElementById("cantidadCreditos").value, 10);
      const codigo = document.getElementById("codigoDescuento").value.trim();

      if (!cantidad || cantidad <= 0) return alert("Cantidad inválida");

      fetch(`${WEBAPP_URL}?action=crearPreferencia&username=${encodeURIComponent(username)}&userId=${encodeURIComponent(userId)}&cantidad=${cantidad}&codigo=${encodeURIComponent(codigo)}`)
        .then(r => r.json())
        .then(data => {
          if (data.url) {
            window.location.href = data.url;
          } else {
            alert("Error al generar link de pago");
          }
        });
    }

    // --- Inicialización ---
    document.addEventListener("DOMContentLoaded", () => {
      actualizarTotal();
      document.getElementById("btnMenos").addEventListener("click", () => {
        document.getElementById("cantidadCreditos").stepDown();
        actualizarTotal();
      });
      document.getElementById("btnMas").addEventListener("click", () => {
        document.getElementById("cantidadCreditos").stepUp();
        actualizarTotal();
      });
      document.getElementById("cantidadCreditos").addEventListener("input", actualizarTotal);
      document.getElementById("codigoDescuento").addEventListener("input", actualizarTotal);
    });

    // --- Protege acceso ---
    const storedUserId = localStorage.getItem("userId");
    const storedUsername = localStorage.getItem("username");
    if (!storedUserId || !storedUsername) {
      window.location.href = "index.html";
    }
    userId = storedUserId;
    username = storedUsername;
    init({ username, userId });

    // --- Nav dinámico ---
    document.getElementById("btnCreditos").href = `creditos.html`;
    document.getElementById("btnConfig").href = `configuracion.html`;
    document.getElementById("btnClientes").href = `clientes.html`;
    document.getElementById("btnTurnos").href = `turnos.html`;
    document.getElementById("btnPerfil").href = `perfil.html`;

    document.getElementById("btnLogout").addEventListener("click", (e) => {
      e.preventDefault();
      localStorage.removeItem("username");
      localStorage.removeItem("userId");
      window.location.href = "index.html";
    });
  </script>

  <script>
    function toggleUserTab() {
      document.getElementById("tabContent").classList.toggle("open");
    }
    document.addEventListener("DOMContentLoaded", () => {
      const username = localStorage.getItem("username");
      if (username) {
        const link = document.getElementById("userLink");
        link.href = "https://turnox.pro/" + encodeURIComponent(username);
        link.textContent = "https://turnox.pro/" + username;
      }
    });
  </script>
</body>
</html>
