<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TurnoX - Sistema PRE-PAGO de Turnos On Line</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

  <!-- Fuentes -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Iconos -->
  <link rel="icon" type="image/png" href="https://i.ibb.co/p6Ycq6XC/Turnox-logo.png">

  <style>
    body {
      font-family: "Montserrat", sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #533482;
      color: #F2F2F2;
    }
    h1 { text-align: center; }
    button {
      background-color: #533482;
      color: #fff;
      border: none;
      padding: 8px 14px;
      margin: 4px 2px;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover { background-color: #452a7a; }
    .profesional {
      border: 1px solid #ddd;
      padding: 12px;
      margin: 12px 0;
      background: #fff;
      color: #533482;
    }
  </style>
</head>
<body onload="init()">
  <button onclick="window.location.href='/'">‚¨Ö Volver al Panel</button>
  <button onclick="
      window.location.href='/creditos.html?username='
      + encodeURIComponent(username)
      + '&userId=' + encodeURIComponent(userId);
    ">
      üí≥ Cr√©ditos
  </button>
  <h1>Panel de Configuraci√≥n</h1>
  <p>Usuario: <b id="username"></b></p>
  <button onclick="agregarProfesional()">Agregar Profesional</button>
  <div id="profesionales"></div>
  <div id="config"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxpL3trtn3QD08UTOBR2ToRNb-UouL0PfiuNjJhDCCcZ-f0UqAacugvHRbgwKQVfHZhfw/exec"; 
let userId = localStorage.getItem("userId");
let username = localStorage.getItem("username");
let profesionales = [];

async function init() {
  if (!userId || !username) {
    alert("Debes iniciar sesi√≥n primero.");
    window.location.href = "/login.html";
    return;
  }
  document.getElementById("username").innerText = username;
  await cargarProfesionales();
}

async function cargarProfesionales() {
  const res = await fetch(`${API_URL}?username=${username}`);
  const data = await res.json();
  if (data.status === "ok") {
    profesionales = data.profesionales;
    renderProfesionales();
  }
}

function renderProfesionales() {
  const cont = document.getElementById("profesionales");
  cont.innerHTML = "";
  profesionales.forEach(prof => {
    const div = document.createElement("div");
    div.className = "profesional";
    div.innerHTML = `
      <h3>${prof.nombre}</h3>
      <button onclick="abrirTurnos('${prof.profesionalId}','${prof.nombre}')">‚öô Configurar Turnos</button>
      <button onclick="eliminarTurnos('${prof.profesionalId}')">üóë Limpiar Turnos</button>
      <button onclick="eliminarProfesional('${prof.profesionalId}')">‚ùå Eliminar Profesional</button>
    `;
    cont.appendChild(div);
  });
}

async function agregarProfesional() {
  const nombre = prompt("Nombre del profesional:");
  if (!nombre) return;
  const formData = new FormData();
  formData.append("action","addProfessional");
  formData.append("userId", userId);
  formData.append("nombre", nombre);
  const res = await fetch(API_URL, {method:"POST", body:formData});
  const data = await res.json();
  if (data.status === "ok") {
    profesionales.push({profesionalId:data.profesionalId, nombre:data.nombre});
    renderProfesionales();
  }
}

// ---------------- CONFIGURACI√ìN DE TURNOS ----------------
async function abrirTurnos(profId, nombre) {
  const dias = ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];
  let html = `<h2>Turnos Standard de ${nombre}</h2>`;
  html += `
    <label>Intervalo: 
      <select id="intervalo">
        <option value="15">15 min</option>
        <option value="20">20 min</option>
        <option value="30" selected>30 min</option>
        <option value="60">60 min</option>
      </select>
    </label><br><br>
  `;
  dias.forEach(d=>{
    html += `
      <h4>${d}</h4>
      Desde <input type="time" id="desde_${d}" value="09:00">
      hasta <input type="time" id="hasta_${d}" value="17:00">
      <button onclick="generarSlots('${profId}','${d}')">Generar</button>
      <div id="slots_${profId}_${d}" class="slots"></div>
    `;
  });
  html += `<br><button onclick="guardarTurnos('${profId}')">üíæ Guardar</button>`;
  document.getElementById("config").innerHTML = html;

  // cargar turnos guardados desde backend
  const res = await fetch(`${API_URL}?action=getTurnosStandard&profesionalId=${profId}`);
  const data = await res.json();
  if (data.status === "ok") {
    data.turnos.forEach(t=>{
      generarSlots(profId, t.dia);
      const chk = document.querySelector(`#${profId}_${t.dia}_${t.hora}`);
      if (chk) chk.checked = t.visible === 1;
    });
  }
}

function generarSlots(profId, dia) {
  const intervalo = parseInt(document.getElementById("intervalo").value);
  const desde = document.getElementById(`desde_${dia}`).value;
  const hasta = document.getElementById(`hasta_${dia}`).value;
  const cont = document.getElementById(`slots_${profId}_${dia}`);
  cont.innerHTML = "";

  let [h,m] = desde.split(":").map(Number);
  let [hf,mf] = hasta.split(":").map(Number);

  while (h < hf || (h===hf && m < mf)) {
    const hora = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
    const id = `${profId}_${dia}_${hora}`;
    cont.innerHTML += `<label><input type="checkbox" id="${id}" data-dia="${dia}" data-hora="${hora}" checked> ${hora}</label> `;
    m += intervalo;
    if (m >= 60) { m = m-60; h++; }
  }
}

async function guardarTurnos(profId) {
  const checkboxes = document.querySelectorAll(`#config input[type=checkbox]`);
  const turnos = [];
  checkboxes.forEach(ch=>{
    turnos.push({dia: ch.dataset.dia, hora: ch.dataset.hora, visible: ch.checked ? 1 : 0});
  });
  const formData = new FormData();
  formData.append("action","saveTurnosStandard");
  formData.append("profesionalId", profId);
  formData.append("turnos", JSON.stringify(turnos));
  await fetch(API_URL, {method:"POST", body:formData});
  alert("Turnos guardados correctamente.");
}

async function eliminarTurnos(profId) {
  if (!confirm("¬øSeguro que quieres limpiar todos los turnos de este profesional?")) return;
  const formData = new FormData();
  formData.append("action","saveTurnosStandard");
  formData.append("profesionalId", profId);
  formData.append("turnos", JSON.stringify([]));
  await fetch(API_URL, {method:"POST", body:formData});
  alert("Turnos eliminados.");
}

async function eliminarProfesional(profId) {
  if (!confirm("‚ùå ¬øEliminar completamente este profesional y sus turnos?")) return;
  const formData = new FormData();
  formData.append("action","deleteProfessional");
  formData.append("profesionalId", profId);
  const res = await fetch(API_URL, {method:"POST", body:formData});
  const data = await res.json();
  if (data.status === "ok") {
    profesionales = profesionales.filter(p => p.profesionalId !== profId);
    renderProfesionales();
    document.getElementById("config").innerHTML = "";
    alert("Profesional eliminado.");
  }
}
</script>
</body>
</html>


